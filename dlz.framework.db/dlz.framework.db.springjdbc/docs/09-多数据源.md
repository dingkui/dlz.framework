# DLZ-DB 帮助文档 - 多数据源

## 9.1 配置

## 配置示例

```yaml
spring:
  datasource:
    # 主库
    master:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://master-host:3306/db_master
      username: root
      password: master123
    
    # 从库
    slave:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://slave-host:3306/db_slave
      username: root
      password: slave123
    
    # 其他业务库
    report:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://report-host:3306/db_report
      username: root
      password: report123

dlz:
  db:
    # 默认数据源
    default-datasource: master
```

## 代码配置（可选）

```java
@Configuration
public class DataSourceConfig {

    @Bean
    @Primary
    public DataSource masterDataSource() {
        // 配置主库
    }
    
    @Bean("slaveDataSource")
    public DataSource slaveDataSource() {
        // 配置从库
    }
}
```
---

## 9.2 切换与事务


### 切换数据源

```java
// 使用默认数据源（master）
DB.query(User.class).list();

// 切换到从库查询
DB.use("slave").query(User.class).list();

// 切换到报表库
List<ResultMap> report = DB.use("report")
    .jdbcSelect("SELECT * FROM daily_report")
    .queryList();
```

### 链式切换

```java
// 从库查询
List<User> users = DB.use("slave")
    .query(User.class)
    .eq(User::getStatus, 1)
    .orderByDesc(User::getCreateTime)
    .list();

// 主库写入
DB.use("master").insert(user).execute();
```

### 事务控制

#### 单数据源事务

```java
@Service
public class UserService {

    @Transactional
    public void createUser(User user) {
        // 同一事务内的操作
        DB.insert(user).execute();
        DB.insert(userLog).execute();
    }
}
```

#### 跨数据源（需要分布式事务）

```java
@Service
public class OrderService {

    // ⚠️ 跨数据源操作需要分布式事务支持
    @Transactional
    public void createOrder(Order order) {
        // 主库写订单
        DB.use("master").insert(order).execute();
        
        // 报表库写统计（不在同一事务！）
        DB.use("report").insert(stats).execute();
    }
}
```

### 读写分离建议

```java
@Service
public class UserService {

    // 写操作 → 主库
    public void save(User user) {
        DB.use("master").insert(user).execute();
    }
    
    // 读操作 → 从库
    public User getById(Long id) {
        return DB.use("slave")
            .query(User.class)
            .eq(User::getId, id)
            .one();
    }
    
    // 需要读取最新数据 → 主库
    public User getByIdFromMaster(Long id) {
        return DB.use("master")
            .query(User.class)
            .eq(User::getId, id)
            .one();
    }
}
```