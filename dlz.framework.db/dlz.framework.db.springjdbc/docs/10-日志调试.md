# DLZ-DB å¸®åŠ©æ–‡æ¡£ - æ—¥å¿—è°ƒè¯•

## 10.1 SQL æ—¥å¿—

### å¼€å¯æ—¥å¿—

```yaml
dlz:
  db:
    # æ˜¯å¦æ‰“å° SQL
    show-sql: true
    # æ˜¯å¦æ ¼å¼åŒ– SQL
    format-sql: true
    # æ…¢ SQL é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
    slow-sql-threshold: 1000
```

### æ—¥å¿—è¾“å‡ºæ ¼å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [SQL]   SELECT * FROM user WHERE id = 1 AND is_deleted = 0         â”‚
â”‚ [å‚æ•°]  id=1                                                         â”‚
â”‚ [è€—æ—¶]  15ms                                                         â”‚
â”‚ [è°ƒç”¨]  c.e.service.UserService.getById(UserService.java:42)        â”‚
â”‚               â””â”€ c.e.controller.UserController.detail(UC.java:28)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ…¢ SQL è­¦å‘Š

```
âš ï¸ [æ…¢SQL] æ‰§è¡Œæ—¶é—´ 2350ms è¶…è¿‡é˜ˆå€¼ 1000ms
[SQL]   SELECT * FROM orders WHERE create_time > '2020-01-01'
[è°ƒç”¨]  c.e.service.OrderService.findAll(OrderService.java:56)
```

### æ—¥å¿—çº§åˆ«æŽ§åˆ¶

```yaml
logging:
  level:
    com.dlz.db: DEBUG    // å¼€å¯è¯¦ç»†æ—¥å¿—
    com.dlz.db.sql: INFO // SQL æ—¥å¿—
```

## 10.2 SQL ä»£ç å®šä½ï¼ˆç‹¬å®¶ç‰¹æ€§ï¼‰

### ç—›ç‚¹

```
ä¼ ç»Ÿå¼€å‘ä¸­çš„é—®é¢˜ï¼š

1. æŽ§åˆ¶å°çœ‹åˆ°ä¸€æ¡æ…¢ SQL
2. ä¸çŸ¥é“æ˜¯å“ªä¸ª Controller/Service æ‰§è¡Œçš„
3. å…¨å±€æœç´¢ SQL å…³é”®è¯ â†’ æ‰¾åˆ° 10+ ä¸ªåœ°æ–¹
4. ä¸€ä¸ªä¸ªæŽ’æŸ¥... 
5. æµªè´¹ 30 åˆ†é’Ÿ

DLZ-DBï¼šç›´æŽ¥å‘Šè¯‰ä½ æ˜¯å“ªè¡Œä»£ç ï¼
```

### æ•ˆæžœå¯¹æ¯”

#### ä¼ ç»Ÿ MyBatis æ—¥å¿—
```
DEBUG - ==>  Preparing: SELECT * FROM user WHERE status = ?
DEBUG - ==> Parameters: 1(Integer)
DEBUG - <==      Total: 50

// ç„¶åŽå‘¢ï¼Ÿè¿™ SQL æ˜¯ä»Žå“ªæ¥çš„ï¼ŸðŸ¤·â€â™‚ï¸
```

#### DLZ-DB æ—¥å¿—
```
[SQL]   SELECT * FROM user WHERE status = 1 AND is_deleted = 0
[è€—æ—¶]  45ms
[è°ƒç”¨]  com.example.service.UserService.findActive(UserService.java:67)
                 â†“
        com.example.controller.UserController.list(UserController.java:34)
        
// ç‚¹å‡» UserService.java:67 ç›´æŽ¥è·³è½¬åˆ°ä»£ç ä½ç½®ï¼âœ…
```

### å®žçŽ°åŽŸç†

```java
// DLZ-DB å†…éƒ¨å®žçŽ°ï¼ˆç®€åŒ–ï¼‰
public void logSql(String sql, long costMs) {
    // 1. èŽ·å–è°ƒç”¨æ ˆ
    StackTraceElement[] stack = Thread.currentThread().getStackTrace();
    
    // 2. è¿‡æ»¤æ¡†æž¶ä»£ç ï¼Œæ‰¾åˆ°ä¸šåŠ¡ä»£ç 
    String location = findBusinessCode(stack);
    
    // 3. æ ¼å¼åŒ–è¾“å‡º
    log.info("[SQL]   {}", sql);
    log.info("[è€—æ—¶]  {}ms", costMs);
    log.info("[è°ƒç”¨]  {}", location);
}
```

### è°ƒç”¨é“¾æ·±åº¦

```yaml
dlz:
  db:
    // æ˜¾ç¤ºè°ƒç”¨é“¾æ·±åº¦ï¼ˆé»˜è®¤ 2ï¼‰
    stack-trace-depth: 3
```

```
[è°ƒç”¨]  UserService.findActive(UserService.java:67)
           â””â”€ UserController.list(UserController.java:34)
               â””â”€ DispatcherServlet.doDispatch(DispatcherServlet.java:1067)
```

### IDE é›†æˆ

ä¸»æµ IDE éƒ½æ”¯æŒç‚¹å‡»è·³è½¬ï¼š
- IntelliJ IDEA âœ…
- Eclipse âœ…
- VS Code âœ…

æ—¥å¿—æ ¼å¼ `ClassName.method(File.java:è¡Œå·)` ç¬¦åˆæ ‡å‡†ï¼Œå¯ç›´æŽ¥ç‚¹å‡»è·³è½¬ã€‚
```