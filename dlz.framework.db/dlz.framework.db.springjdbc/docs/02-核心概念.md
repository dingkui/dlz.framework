# DLZ-DB 帮助文档 - 核心概念

## 2.1 架构设计

### 设计理念

DLZ-DB 的核心设计理念是：**极简、直观、可追踪**

```
传统模式：
Controller → Service → ServiceImpl → Mapper → XML → DB

DLZ-DB 模式：
Controller → DB → 数据库
```

### 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        应用层                                            │
│  ┌───────────────────────────────┐ ┌────────────────────────────────┐   │
│  │               DB (统一入口)     │ │    CommonService入口           │   │
│  └───────────────────────────────┘  └───────────────────────────────┘   │
│                            │               │                            │
│           ┌────────────────┼───────────────┼───────────┐                │
│           ▼                ▼               ▼           ▼                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   ┌─────────────┐    │
│  │   Wrapper   │  │    Maker    │  │  JdbcQuery  │   │  SqlKey     │    │
│  │ (Bean操作)   │  │ (表名操作)  │   │ (原生SQL)    │  │ (预设 SQL)    │    │
│  └─────────────┘  └─────────────┘  └─────────────┘   └─────────────┘    │
│           │                │                │              │            │
│           └────────────────┼────────────────┼──────────────┘            │
│                            ▼                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │               SQL Builder (SQL构建器)                │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ▼                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  SQL Logger (日志)                   │   │
│  │              · 完整SQL · 耗时 · 代码定位               │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ▼                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  JDBC Template                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
└────────────────────────────┼────────────────────────────────┘
                             ▼
                    ┌─────────────┐
                    │   Database  │
                    └─────────────┘
```

## 核心组件

### 使用模式
 * 两种使用模式（熟悉一种即可）

| 使用模式              | 职责      | 说明           |
|-------------------|---------|--------------|
| **DB**            | 统一入口    | 所有操作的起点      |
| **CommonService** | Bean 操作 | 基于实体类的类型安全操作 |

### sql构造器
 * 5种sql构造器（熟悉一两种即可）

| sql构造器          | 职责      | 说明              |
|-----------------|---------|-----------------|
| **Wrapper**     | Bean 操作 | 基于实体类的类型安全操作    |
| **Maker**       | 表名操作    | 基于表名和字段名的动态操作   |
| **Condition**   | 条件构造    | 构建 WHERE 条件     |
| **JdbcQuery**   | 原生 SQL  | 执行原生 SQL        |
| **SqlKeyQuery** | 预设 SQL  | 通过 Key 调用预设 SQL |

### 结果集
 * 3种结果（按需要取得结果）

| 查询结果        | 职责       | 说明                           |
|-------------|----------|------------------------------|
| **?**       | 取得单条结果   | 查询到多条时取第一条,取不到结果返回空。支持多条结果报错 |
| **List<?>** | 查询结果集    |                              |
| **Page<?>** | 取得带翻页结果集 | 总条数和当前页结果。总条数为0，不查询结果        |
| **count**   | 计算条数     | 将普通sql转换成count sql执行并取得条数    |

### 结果集类型
 * 多种结果类型，按需要查询，省去各种转换

| 查询类型          | 说明                 | 优点               | 缺点          |
|---------------|--------------------|------------------|-------------|
| **ResultMap** | 继承自JSONMap         | 支持多级取值，支持任意类型转换  | 字段名为字符串可能出错 |
| **Bean**      | 指定的bean            | 字段映射支持驼峰命名，自定义绑定 | 数据类型固定      |
| **String**    | 结果中有一个字段或多个字段，取第一个 | 最快捷的方式取出查询结果     | 无           |
| **Long**      | 同上                 | 同上               | 无           |
| **Integer**   | 同上                 | 同上               | 无           |
| **Double**    | 同上                 | 同上               | 无           |

---

## 2.2 核心对象

### 核心对象

## 1. DB 类

> 所有数据库操作的统一入口

```java
// 查询
DB.query(User.class)          // Wrapper 查询（推荐）
DB.query("user")              // Maker 查询
DB.jdbcSelect(sql, args)      // 原生 SQL 查询
DB.sqlSelect("key")           // 预设 SQL 查询

// 插入
DB.insert(user)               // Wrapper 插入
DB.insert("user")             // Maker 插入

// 更新
DB.update(user)               // Wrapper 更新
DB.update("user")             // Maker 更新

// 删除
DB.delete(User.class)         // Wrapper 删除
DB.delete("user")             // Maker 删除

// 多数据源
DB.use("slave")               // 切换数据源
```

## 2. Wrapper 系列

> 基于 Bean 的类型安全操作

```java
WrapperQuery<T>     // 查询 Wrapper
WrapperInsert<T>    // 插入 Wrapper
WrapperUpdate<T>    // 更新 Wrapper
WrapperDelete<T>    // 删除 Wrapper
```

**特点：**

- 支持 Lambda 表达式引用字段
- 编译期类型检查
- IDE 自动补全

## 3. Maker 系列

> 基于表名的动态操作

```java
MakerSelect    // 查询构建器
        MakerInsert    // 插入构建器
MakerUpdate    // 更新构建器
        MakerDelete    // 删除构建器
```

**特点：**

- 不需要实体类
- 适合动态表名场景
- 更加灵活

## 4. Condition 条件构造器

> 独立的条件构造器，可复用

```java
Condition condition = Condition.where()
        .eq("status", 1)
        .gt("age", 18)
        .or(w -> w.eq("type", 1).eq("type", 2));

// 可以应用到不同操作
DB.query("user").where(condition).list();
DB.update("user").set("flag",1).where(condition).excute();
DB.delete("user").where(condition).excute();
```

## 5. ResultMap 结果对象

> 查询结果，继承自 JSONMap，支持深度取值

```java
ResultMap result = DB.query("user").eq("id", 1).query();

// 基础取值
result.getStr("name");
result.getInt("age",0);

// 深度取值
result.getStr("profile.address.city","未知");
result.getList("orders",Order.class);
```

## 6. Page 分页对象

> 封装分页参数和结果

```java
// 创建分页参数
Page page = Page.build(1, 10);                    // 第1页，10条
Page page = Page.build(1, 10, Order.desc("id"));  // 带排序

// 分页结果
Page<User> result = DB.query(User.class).page(page).page();
List<User> records = result.getRecords();  // 数据列表
long total = result.getTotal();            // 总条数
int pages = result.getPages();             // 总页数
```
---

## 2.3 工作流程

### 查询数据流程

```
1. 调用 DB.query()
   ↓
2. 链式添加条件 (.eq(), .like(), ...)
   ↓
3. 链式添加排序，分页 ( .orderBy(),.page()... )
   ↓
4. 构建 SQL
   ↓
5. 日志输出（SQL + 耗时 + 代码位置）
   ↓
6. 执行 JDBC
   ↓
7. 结果映射（Bean / Map / ResultMap）
   ↓
8. 返回结果
```

### 更新数据流程
```
1. 调用 DB.update()
   ↓
2. 链式设置值 (.set(key,value), .set(Map<key,value>))
   ↓
3. 链式添加条件 (.eq(), .like()...)
   ↓
4. 构建 SQL
   ↓
5. 日志输出（SQL + 耗时 + 代码位置）
   ↓
6. 执行 JDBC
   ↓
7. 返回结果（影响条数）
```

### 删除数据流程
```
1. 调用 DB.delete()
   ↓
2. 链式添加条件 (.eq(), .like()...)
   ↓
3. 构建 SQL
   ↓
4. 日志输出（SQL + 耗时 + 代码位置）
   ↓
5. 执行 JDBC
   ↓
6. 返回结果（影响条数）
```

### 新增数据流程
```
1. 调用 DB.insert()
   ↓
2. 链式设置值 (.value(key,value), .value(Map<key,value>))
   ↓
3. 构建 SQL
   ↓
4. 日志输出（SQL + 耗时 + 代码位置）
   ↓
5. 执行 JDBC
   ↓
6. 返回结果（影响条数）
```

### 条件构建流程
```java
DB.query(User.class)
    .eq(User::getStatus, 1)      // status = 1
    .gt(User::getAge, 18)        // AND age > 18
    .or(w -> w                   // AND (
        .eq(User::getType, 1)    //     type = 1
        .eq(User::getType, 2)    //     OR type = 2
    )                            // )
    .list();

// 最终 SQL：
// SELECT * FROM user 
// WHERE status = 1 AND age > 18 AND (type = 1 OR type = 2) 
// AND is_deleted = 0
```

### 日志输出流程
```java
DB.query(User.class).eq(User::getId, 1).list();
//输出日志如下：
//18:00:51.240 INFO [pJwECms9 main] caller:(UserService.java:42) c.d.framework.db.util.DbLogUtil:109 getList 15ms sql:SELECT * FROM user WHERE id = 1  
```
```
┌─ SQL 执行前 ─────────────────────────────────────┐
│ 1. 获取完整 SQL（参数已填充）                      │
│ 2. 记录开始时间                                  │
└─────────────────────────────────────────────────┘
                    ↓
┌─ SQL 执行 ──────────────────────────────────────┐
│ JDBC 执行 SQL                                   │
└─────────────────────────────────────────────────┘
                    ↓
┌─ SQL 执行后 ────────────────────────────────────┐
│ 1. 计算执行耗时                                  │
│ 2. 获取调用栈，定位业务代码                       │
│ 3. 格式化输出日志                                │
│                                                │
│ [time]  18:00:51.240                           │
│ [TraceId]  pJwECms9                            │
│ [TheadId]  main                                │
│ [调用]  caller:(UserService.java:42)            │
│ [日志输出] c.d.framework.db.util.DbLogUtil:109   │
│ [DAO方法]  getList                              │
│ [耗时]  15ms                                    │
│ [SQL]  SELECT * FROM user WHERE id = 1         │
└────────────────────────────────────────────────┘
```
