# DLZ-DB 帮助文档 - 最佳实践

## 12.1 使用建议

### 场景选择

| 场景 | 推荐方式 | 说明 |
|------|---------|------|
| 简单 CRUD | Wrapper | 类型安全，推荐 |
| 动态表名 | Maker | 灵活 |
| 复杂查询 | 原生 SQL / 预设 SQL | 可读性好 |
| 报表统计 | 预设 SQL | 便于维护 |
| 批量操作 | 批量 API | 性能好 |

### 代码组织

#### 简单业务：Controller 直接调用

```java
@RestController
public class UserController {

    @GetMapping("/users")
    public List<User> list(@RequestParam(required = false) Integer status) {
        return DB.Wrapper.select(User.class)
            .eq(status != null, User::getStatus, status)
            .list();
    }
}
```

#### 复杂业务：封装 Query 类

```java
// 查询类封装
public class UserQuery {
    
    public static List<User> findByCondition(UserSearchDTO dto) {
        return DB.Wrapper.select(User.class)
            .eq(dto.getStatus() != null, User::getStatus, dto.getStatus())
            .like(StringUtil.isNotBlank(dto.getName()), User::getName, dto.getName())
            .between(dto.getStartDate() != null, User::getCreateTime, dto.getStartDate(), dto.getEndDate())
            .orderByDesc(User::getCreateTime)
            .list();
    }
}

// Controller 调用
@GetMapping("/users")
public List<User> list(UserSearchDTO dto) {
    return UserQuery.findByCondition(dto);
}
```

#### 需要事务：Service 层

```java
@Service
public class OrderService {

    @Transactional
    public Long createOrder(OrderDTO dto) {
        // 复杂业务逻辑
        // ...
    }
}
```

### 条件构建

```java
// ✅ 推荐：条件判断前置
DB.Wrapper.select(User.class)
    .eq(status != null, User::getStatus, status)
    .like(StringUtil.isNotBlank(name), User::getName, name)
    .list();

// ❌ 不推荐：大量 if-else
WrapperQuery<User> query = DB.Wrapper.select(User.class);
if (status != null) {
    query.eq(User::getStatus, status);
}
if (StringUtil.isNotBlank(name)) {
    query.like(User::getName, name);
}
// ...太多 if-else
```
---

## 12.2 性能优化

### 查询优化

#### 只查需要的字段

```java
// ❌ 查询全部字段
DB.Wrapper.select(User.class).list();

// ✅ 只查需要的字段
DB.Wrapper.select(User.class)
    .select(User::getId, User::getName)
    .list();
```

#### 分页查询

```java
// ❌ 查询全部再截取
List<User> all = DB.Wrapper.select(User.class).list();
List<User> page = all.subList(0, 10);

// ✅ 数据库分页
Page<User> page = DB.Wrapper.select(User.class)
    .page(Page.build(1, 10))
    .page();
```

#### 避免 N+1 问题

```java
// ❌ N+1 问题
List<Order> orders = DB.Wrapper.select(Order.class).list();
for (Order order : orders) {
    User user = DB.Wrapper.select(User.class)
        .eq(User::getId, order.getUserId())
        .one();  // 每次循环都查询
}

// ✅ 批量查询
List<Order> orders = DB.Wrapper.select(Order.class).list();
List<Long> userIds = orders.stream()
    .map(Order::getUserId)
    .distinct()
    .collect(Collectors.toList());
    
Map<Long, User> userMap = DB.Wrapper.select(User.class)
    .in(User::getId, userIds)
    .list()
    .stream()
    .collect(Collectors.toMap(User::getId, u -> u));
```

### 写入优化

#### 批量插入

```java
// ❌ 循环单条插入
for (User user : users) {
    DB.Wrapper.insert(user).execute();
}

// ✅ 批量插入
DB.insertBatch(users).execute();
```

### 索引优化

```java
// ✅ 使用索引字段作为查询条件
DB.Wrapper.select(User.class)
    .eq(User::getId, id)        // 主键索引
    .eq(User::getPhone, phone)  // 唯一索引
    .list();

// ⚠️ 避免索引失效
DB.Wrapper.select(User.class)
    .apply("YEAR(create_time) = {0}", 2024)  // 函数导致索引失效
    .list();

// ✅ 改为范围查询
DB.Wrapper.select(User.class)
    .between(User::getCreateTime, startOfYear, endOfYear)
    .list();
```

---

## 12.3 安全规范

### SQL 注入防护

#### 使用参数化查询

```java
// ✅ 安全：参数化查询
DB.Wrapper.select(User.class)
    .eq(User::getName, userInput)
    .list();

// ✅ 安全：使用 #{} 占位符
DB.Sql.select("user.find")
    .addPara("name", userInput)
    .queryList();

// ✅ 安全：使用 ? 占位符
DB.Jdbc.select("SELECT * FROM user WHERE name = ?", userInput)
    .queryList();

// ❌ 危险：字符串拼接
String sql = "SELECT * FROM user WHERE name = '" + userInput + "'";
```

#### 动态排序安全

```java
// ❌ 危险：直接使用用户输入
String sort = request.getParameter("sort");
query.addPara("sortField", sort);

// ✅ 安全：白名单校验
Set<String> ALLOWED_SORTS = Set.of("id", "name", "create_time");
String sort = request.getParameter("sort");
if (!ALLOWED_SORTS.contains(sort)) {
    sort = "create_time";  // 默认值
}
query.addPara("sortField", sort);
```

### 敏感数据处理

```java
// 日志脱敏（配置）
dlz:
  db:
    // 需要脱敏的字段
    sensitive-fields:
      - password
      - phone
      - id_card
```

### 权限控制

```java
// 数据权限过滤
public List<Order> findMyOrders() {
    Long currentUserId = SecurityContext.getCurrentUserId();
    
    return DB.Wrapper.select(Order.class)
        .eq(Order::getUserId, currentUserId)  // 只能看自己的
        .list();
}
```