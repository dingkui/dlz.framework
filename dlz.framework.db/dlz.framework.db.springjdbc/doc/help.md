# DLZ-DB å¸®åŠ©æ–‡æ¡£ä½“ç³»

## ä¸€ã€æ–‡æ¡£ç›®å½•ç»“æ„

```
docs/
â”œâ”€â”€ 01-å¿«é€Ÿå¼€å§‹/
â”‚   â”œâ”€â”€ 1.1-ç¯å¢ƒè¦æ±‚.md
â”‚   â”œâ”€â”€ 1.2-å®‰è£…é…ç½®.md
â”‚   â””â”€â”€ 1.3-ç¬¬ä¸€ä¸ªç¤ºä¾‹.md
â”‚
â”œâ”€â”€ 02-æ ¸å¿ƒæ¦‚å¿µ/
â”‚   â”œâ”€â”€ 2.1-æ¶æ„è®¾è®¡.md
â”‚   â”œâ”€â”€ 2.2-æ ¸å¿ƒå¯¹è±¡.md
â”‚   â””â”€â”€ 2.3-å·¥ä½œæµç¨‹.md
â”‚
â”œâ”€â”€ 03-åŸºç¡€æ“ä½œ/
â”‚   â”œâ”€â”€ 3.1-æŸ¥è¯¢æ“ä½œ.md
â”‚   â”œâ”€â”€ 3.2-æ’å…¥æ“ä½œ.md
â”‚   â”œâ”€â”€ 3.3-æ›´æ–°æ“ä½œ.md
â”‚   â””â”€â”€ 3.4-åˆ é™¤æ“ä½œ.md
â”‚
â”œâ”€â”€ 04-æ¡ä»¶æ„é€ å™¨/
â”‚   â”œâ”€â”€ 4.1-åŸºç¡€æ¡ä»¶.md
â”‚   â”œâ”€â”€ 4.2-é€»è¾‘ç»„åˆ.md
â”‚   â”œâ”€â”€ 4.3-æ¨¡ç³ŠæŸ¥è¯¢.md
â”‚   â”œâ”€â”€ 4.4-èŒƒå›´æŸ¥è¯¢.md
â”‚   â””â”€â”€ 4.5-è‡ªå®šä¹‰SQL.md
â”‚
â”œâ”€â”€ 05-åˆ†é¡µæ’åº/
â”‚   â”œâ”€â”€ 5.1-åˆ†é¡µæŸ¥è¯¢.md
â”‚   â””â”€â”€ 5.2-æ’åº.md
â”‚
â”œâ”€â”€ 06-ç»“æœæ˜ å°„/
â”‚   â”œâ”€â”€ 6.1-Beanæ˜ å°„.md
â”‚   â”œâ”€â”€ 6.2-Mapæ˜ å°„.md
â”‚   â””â”€â”€ 6.3-ResultMapæ·±åº¦å–å€¼.md
â”‚
â”œâ”€â”€ 07-Lambdaè¡¨è¾¾å¼/
â”‚   â””â”€â”€ 7.1-ç±»å‹å®‰å…¨çš„å­—æ®µå¼•ç”¨.md
â”‚
â”œâ”€â”€ 08-é¢„è®¾SQL/
â”‚   â”œâ”€â”€ 8.1-Key-SQLæ¦‚å¿µ.md
â”‚   â”œâ”€â”€ 8.2-åŠ¨æ€æ¡ä»¶.md
â”‚   â””â”€â”€ 8.3-SQLåµŒå¥—.md
â”‚
â”œâ”€â”€ 09-å¤šæ•°æ®æº/
â”‚   â”œâ”€â”€ 9.1-é…ç½®.md
â”‚   â””â”€â”€ 9.2-åˆ‡æ¢ä¸äº‹åŠ¡.md
â”‚
â”œâ”€â”€ 10-æ—¥å¿—è°ƒè¯•/
â”‚   â”œâ”€â”€ 10.1-SQLæ—¥å¿—.md
â”‚   â””â”€â”€ 10.2-ä»£ç å®šä½.md
â”‚
â”œâ”€â”€ 11-é«˜çº§ç‰¹æ€§/
â”‚   â”œâ”€â”€ 11.1-é€»è¾‘åˆ é™¤.md
â”‚   â”œâ”€â”€ 11.2-æ‰¹é‡æ“ä½œ.md
â”‚   â””â”€â”€ 11.3-äº‹åŠ¡ç®¡ç†.md
â”‚
â”œâ”€â”€ 12-æœ€ä½³å®è·µ/
â”‚   â”œâ”€â”€ 12.1-ä½¿ç”¨å»ºè®®.md
â”‚   â”œâ”€â”€ 12.2-æ€§èƒ½ä¼˜åŒ–.md
â”‚   â””â”€â”€ 12.3-å®‰å…¨è§„èŒƒ.md
â”‚
â”œâ”€â”€ 13-APIå‚è€ƒ/
â”‚   â”œâ”€â”€ 13.1-DBç±».md
â”‚   â”œâ”€â”€ 13.2-Wrapperç±».md
â”‚   â”œâ”€â”€ 13.3-Conditionç±».md
â”‚   â””â”€â”€ 13.4-Pageç±».md
â”‚
â””â”€â”€ 14-é™„å½•/
    â”œâ”€â”€ 14.1-FAQ.md
    â””â”€â”€ 14.2-æ›´æ–°æ—¥å¿—.md
```

---

## äºŒã€å„ç« èŠ‚è¯¦ç»†å†…å®¹

---

# ğŸ“˜ ç¬¬ä¸€ç« ï¼šå¿«é€Ÿå¼€å§‹

## 1.1 ç¯å¢ƒè¦æ±‚

```markdown
# ç¯å¢ƒè¦æ±‚

## åŸºç¡€ç¯å¢ƒ

| ç¯å¢ƒ | ç‰ˆæœ¬è¦æ±‚ | è¯´æ˜ |
|------|---------|------|
| JDK | 8+ | æ”¯æŒ JDK 8ã€11ã€17ã€21 |
| Maven | 3.6+ | æˆ– Gradle 6+ |
| Spring Boot | 2.x / 3.x | å¯é€‰ï¼Œæ”¯æŒé Spring ç¯å¢ƒ |

## æ”¯æŒçš„æ•°æ®åº“

| æ•°æ®åº“ | ç‰ˆæœ¬ | æµ‹è¯•çŠ¶æ€ |
|--------|------|---------|
| MySQL | 5.7+ | âœ… å®Œå…¨æ”¯æŒ |
| PostgreSQL | 10+ | âœ… å®Œå…¨æ”¯æŒ |
| Oracle | 11g+ | âœ… å®Œå…¨æ”¯æŒ |
| SQL Server | 2012+ | âœ… å®Œå…¨æ”¯æŒ |
| è¾¾æ¢¦ | DM8 | âœ… å®Œå…¨æ”¯æŒ |
| äººå¤§é‡‘ä»“ | V8 | âœ… å®Œå…¨æ”¯æŒ |

## ä¾èµ–è¯´æ˜

DLZ-DB æ ¸å¿ƒä¾èµ–ï¼š
- spring-jdbcï¼ˆå¯é€‰ï¼‰
- jackson-databindï¼ˆç”¨äº JSON å¤„ç†ï¼‰

æ— å…¶ä»–é‡å‹ä¾èµ–ï¼Œä¿æŒè½»é‡ã€‚
```

---

## 1.2 å®‰è£…é…ç½®

```markdown
# å®‰è£…é…ç½®

## Maven å¼•å…¥

### æ–¹å¼ä¸€ï¼šå®Œæ•´å¼•å…¥ï¼ˆæ¨èï¼‰

â€‹```xml
<dependency>
    <groupId>com.dlz</groupId>
    <artifactId>dlz-db-spring-boot-starter</artifactId>
    <version>${æœ€æ–°ç‰ˆæœ¬}</version>
</dependency>
â€‹```

### æ–¹å¼äºŒï¼šæ ¸å¿ƒåŒ…å¼•å…¥

â€‹```xml
<dependency>
    <groupId>com.dlz</groupId>
    <artifactId>dlz-db-core</artifactId>
    <version>${æœ€æ–°ç‰ˆæœ¬}</version>
</dependency>
â€‹```

## æ•°æ®æºé…ç½®

### Spring Boot é…ç½®

â€‹```yaml
# application.yml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test?useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: 123456

# DLZ-DB é…ç½®ï¼ˆå¯é€‰ï¼‰
dlz:
  db:
    # æ˜¯å¦æ‰“å° SQL æ—¥å¿—
    show-sql: true
    # æ˜¯å¦æ˜¾ç¤ºä»£ç å®šä½
    show-location: true
    # æ…¢ SQL é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
    slow-sql-threshold: 1000
    # é€»è¾‘åˆ é™¤å­—æ®µå
    logic-delete-field: is_deleted
    # é€»è¾‘åˆ é™¤å€¼
    logic-delete-value: 1
    # é€»è¾‘æœªåˆ é™¤å€¼
    logic-not-delete-value: 0
â€‹```

### å¤šæ•°æ®æºé…ç½®

â€‹```yaml
spring:
  datasource:
    master:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://master:3306/db
      username: root
      password: 123456
    slave:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://slave:3306/db
      username: root
      password: 123456

dlz:
  db:
    default-datasource: master
â€‹```
```

---

## 1.3 ç¬¬ä¸€ä¸ªç¤ºä¾‹

```markdown
# ç¬¬ä¸€ä¸ªç¤ºä¾‹

## 5 åˆ†é’Ÿå¿«é€Ÿä½“éªŒ

### 1. åˆ›å»ºæ•°æ®è¡¨

â€‹```sql
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) DEFAULT NULL,
  `age` int DEFAULT NULL,
  `email` varchar(100) DEFAULT NULL,
  `is_deleted` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
);

INSERT INTO user (name, age, email) VALUES 
('å¼ ä¸‰', 25, 'zhangsan@example.com'),
('æå››', 30, 'lisi@example.com'),
('ç‹äº”', 28, 'wangwu@example.com');
â€‹```

### 2. åˆ›å»ºå®ä½“ç±»ï¼ˆå¯é€‰ï¼‰

â€‹```java
@Data
@Table("user")  // å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ç±»åè½¬ä¸‹åˆ’çº¿
public class User {
    private Long id;
    private String name;
    private Integer age;
    private String email;
    private Integer isDeleted;
    private Date createTime;
}
â€‹```

### 3. å¼€å§‹ä½¿ç”¨

â€‹```java
@RestController
@RequestMapping("/user")
public class UserController {

    // ========== æŸ¥è¯¢ ==========
    
    @GetMapping("/{id}")
    public User getById(@PathVariable Long id) {
        return DB.query(User.class)
            .eq(User::getId, id)
            .one();
    }
    
    @GetMapping("/list")
    public List<User> list(@RequestParam(required = false) String name) {
        return DB.query(User.class)
            .like(name != null, User::getName, name)
            .orderByDesc(User::getCreateTime)
            .list();
    }
    
    // ========== æ–°å¢ ==========
    
    @PostMapping
    public Long add(@RequestBody User user) {
        return DB.insert(user).insertWithAutoKey();
    }
    
    // ========== ä¿®æ”¹ ==========
    
    @PutMapping
    public void update(@RequestBody User user) {
        DB.update(user)
            .eq(User::getId, user.getId())
            .execute();
    }
    
    // ========== åˆ é™¤ ==========
    
    @DeleteMapping("/{id}")
    public void delete(@PathVariable Long id) {
        DB.delete(User.class)
            .eq(User::getId, id)
            .execute();
    }
}
â€‹```

### 4. æŸ¥çœ‹æ—¥å¿—

â€‹```
[SQL]   SELECT * FROM user WHERE id = 1 AND is_deleted = 0
[è€—æ—¶]  12ms
[è°ƒç”¨]  c.e.controller.UserController.getById(UserController.java:15)
â€‹```

**æ­å–œï¼ä½ å·²ç»å®Œæˆäº†ç¬¬ä¸€ä¸ª DLZ-DB åº”ç”¨ï¼**
```

---

# ğŸ“˜ ç¬¬äºŒç« ï¼šæ ¸å¿ƒæ¦‚å¿µ

## 2.1 æ¶æ„è®¾è®¡

```markdown
# æ¶æ„è®¾è®¡

## è®¾è®¡ç†å¿µ

DLZ-DB çš„æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯ï¼š**æç®€ã€ç›´è§‚ã€å¯è¿½è¸ª**

â€‹```
ä¼ ç»Ÿæ¨¡å¼ï¼š
Controller â†’ Service â†’ ServiceImpl â†’ Mapper â†’ XML â†’ DB

DLZ-DB æ¨¡å¼ï¼š
Controller â†’ DB â†’ æ•°æ®åº“
â€‹```

## æ¶æ„å›¾

â€‹```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº”ç”¨å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    DB (ç»Ÿä¸€å…¥å£)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚           â–¼                â–¼                â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Wrapper   â”‚  â”‚    Maker    â”‚  â”‚  JdbcQuery  â”‚        â”‚
â”‚  â”‚ (Beanæ“ä½œ)  â”‚  â”‚ (è¡¨åæ“ä½œ)  â”‚  â”‚ (åŸç”ŸSQL)   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚                â”‚                â”‚              â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                            â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚               SQL Builder (SQLæ„å»ºå™¨)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                â”‚
â”‚                            â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  SQL Logger (æ—¥å¿—)                   â”‚   â”‚
â”‚  â”‚              Â· å®Œæ•´SQL Â· è€—æ—¶ Â· ä»£ç å®šä½              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                â”‚
â”‚                            â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  JDBC Template                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Database  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â€‹```

## æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | è¯´æ˜ |
|------|------|------|
| **DB** | ç»Ÿä¸€å…¥å£ | æ‰€æœ‰æ“ä½œçš„èµ·ç‚¹ |
| **Wrapper** | Bean æ“ä½œ | åŸºäºå®ä½“ç±»çš„ç±»å‹å®‰å…¨æ“ä½œ |
| **Maker** | è¡¨åæ“ä½œ | åŸºäºè¡¨åçš„åŠ¨æ€æ“ä½œ |
| **Condition** | æ¡ä»¶æ„é€  | æ„å»º WHERE æ¡ä»¶ |
| **JdbcQuery** | åŸç”Ÿ SQL | æ‰§è¡ŒåŸç”Ÿ SQL |
| **SqlKeyQuery** | é¢„è®¾ SQL | é€šè¿‡ Key è°ƒç”¨é¢„è®¾ SQL |
| **ResultMap** | ç»“æœå°è£… | æŸ¥è¯¢ç»“æœï¼Œæ”¯æŒæ·±åº¦å–å€¼ |
| **Page** | åˆ†é¡µå°è£… | åˆ†é¡µå‚æ•°å’Œç»“æœ |
```

---

## 2.2 æ ¸å¿ƒå¯¹è±¡

```markdown
# æ ¸å¿ƒå¯¹è±¡

## 1. DB ç±»

> æ‰€æœ‰æ•°æ®åº“æ“ä½œçš„ç»Ÿä¸€å…¥å£

â€‹```java
// æŸ¥è¯¢
DB.query(User.class)          // Wrapper æŸ¥è¯¢ï¼ˆæ¨èï¼‰
DB.query("user")              // Maker æŸ¥è¯¢
DB.jdbcSelect(sql, args)      // åŸç”Ÿ SQL æŸ¥è¯¢
DB.sqlSelect("key")           // é¢„è®¾ SQL æŸ¥è¯¢

// æ’å…¥
DB.insert(user)               // Wrapper æ’å…¥
DB.insert("user")             // Maker æ’å…¥

// æ›´æ–°
DB.update(user)               // Wrapper æ›´æ–°
DB.update("user")             // Maker æ›´æ–°

// åˆ é™¤
DB.delete(User.class)         // Wrapper åˆ é™¤
DB.delete("user")             // Maker åˆ é™¤

// å¤šæ•°æ®æº
DB.use("slave")               // åˆ‡æ¢æ•°æ®æº
â€‹```

## 2. Wrapper ç³»åˆ—

> åŸºäº Bean çš„ç±»å‹å®‰å…¨æ“ä½œ

â€‹```java
WrapperQuery<T>     // æŸ¥è¯¢ Wrapper
WrapperInsert<T>    // æ’å…¥ Wrapper
WrapperUpdate<T>    // æ›´æ–° Wrapper
WrapperDelete<T>    // åˆ é™¤ Wrapper
â€‹```

**ç‰¹ç‚¹ï¼š**
- æ”¯æŒ Lambda è¡¨è¾¾å¼å¼•ç”¨å­—æ®µ
- ç¼–è¯‘æœŸç±»å‹æ£€æŸ¥
- IDE è‡ªåŠ¨è¡¥å…¨

## 3. Maker ç³»åˆ—

> åŸºäºè¡¨åçš„åŠ¨æ€æ“ä½œ

â€‹```java
MakerSelect    // æŸ¥è¯¢æ„å»ºå™¨
MakerInsert    // æ’å…¥æ„å»ºå™¨
MakerUpdate    // æ›´æ–°æ„å»ºå™¨
MakerDelete    // åˆ é™¤æ„å»ºå™¨
â€‹```

**ç‰¹ç‚¹ï¼š**
- ä¸éœ€è¦å®ä½“ç±»
- é€‚åˆåŠ¨æ€è¡¨ååœºæ™¯
- æ›´åŠ çµæ´»

## 4. Condition æ¡ä»¶æ„é€ å™¨

> ç‹¬ç«‹çš„æ¡ä»¶æ„é€ å™¨ï¼Œå¯å¤ç”¨

â€‹```java
Condition condition = Condition.where()
    .eq("status", 1)
    .gt("age", 18)
    .or(w -> w.eq("type", 1).eq("type", 2));

// å¯ä»¥åº”ç”¨åˆ°ä¸åŒæ“ä½œ
DB.query("user").where(condition).list();
DB.update("user").set("flag", 1).where(condition).execute();
DB.delete("user").where(condition).execute();
â€‹```

## 5. ResultMap ç»“æœå¯¹è±¡

> æŸ¥è¯¢ç»“æœï¼Œç»§æ‰¿è‡ª JSONMapï¼Œæ”¯æŒæ·±åº¦å–å€¼

â€‹```java
ResultMap result = DB.query("user").eq("id", 1).one();

// åŸºç¡€å–å€¼
result.getStr("name");
result.getInt("age", 0);

// æ·±åº¦å–å€¼
result.getStr("profile.address.city", "æœªçŸ¥");
result.getList("orders", Order.class);
â€‹```

## 6. Page åˆ†é¡µå¯¹è±¡

> å°è£…åˆ†é¡µå‚æ•°å’Œç»“æœ

â€‹```java
// åˆ›å»ºåˆ†é¡µå‚æ•°
Page page = Page.build(1, 10);                    // ç¬¬1é¡µï¼Œ10æ¡
Page page = Page.build(1, 10, Order.desc("id"));  // å¸¦æ’åº

// åˆ†é¡µç»“æœ
Page<User> result = DB.query(User.class).page(page).page();
List<User> records = result.getRecords();  // æ•°æ®åˆ—è¡¨
long total = result.getTotal();            // æ€»æ¡æ•°
int pages = result.getPages();             // æ€»é¡µæ•°
â€‹```
```

---

## 2.3 å·¥ä½œæµç¨‹

```markdown
# å·¥ä½œæµç¨‹

## æŸ¥è¯¢æµç¨‹

â€‹```
1. è°ƒç”¨ DB.query()
       â†“
2. é“¾å¼æ·»åŠ æ¡ä»¶ (.eq(), .like(), .orderBy()...)
       â†“
3. æ„å»º SQL
       â†“
4. æ—¥å¿—è¾“å‡ºï¼ˆSQL + è€—æ—¶ + ä»£ç ä½ç½®ï¼‰
       â†“
5. æ‰§è¡Œ JDBC
       â†“
6. ç»“æœæ˜ å°„ï¼ˆBean / Map / ResultMapï¼‰
       â†“
7. è¿”å›ç»“æœ
â€‹```

## æ¡ä»¶æ„å»ºæµç¨‹

â€‹```java
DB.query(User.class)
    .eq(User::getStatus, 1)      // status = 1
    .gt(User::getAge, 18)        // AND age > 18
    .or(w -> w                   // AND (
        .eq(User::getType, 1)    //     type = 1
        .eq(User::getType, 2)    //     OR type = 2
    )                            // )
    .list();

// æœ€ç»ˆ SQLï¼š
// SELECT * FROM user 
// WHERE status = 1 AND age > 18 AND (type = 1 OR type = 2) 
// AND is_deleted = 0
â€‹```

## æ—¥å¿—è¾“å‡ºæµç¨‹

â€‹```
â”Œâ”€ SQL æ‰§è¡Œå‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è·å–å®Œæ•´ SQLï¼ˆå‚æ•°å·²å¡«å……ï¼‰                      â”‚
â”‚ 2. è®°å½•å¼€å§‹æ—¶é—´                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€ SQL æ‰§è¡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JDBC æ‰§è¡Œ SQL                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€ SQL æ‰§è¡Œå â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è®¡ç®—æ‰§è¡Œè€—æ—¶                                  â”‚
â”‚ 2. è·å–è°ƒç”¨æ ˆï¼Œå®šä½ä¸šåŠ¡ä»£ç                        â”‚
â”‚ 3. æ ¼å¼åŒ–è¾“å‡ºæ—¥å¿—                                â”‚
â”‚                                                 â”‚
â”‚ [SQL]   SELECT * FROM user WHERE id = 1         â”‚
â”‚ [è€—æ—¶]  15ms                                    â”‚
â”‚ [è°ƒç”¨]  UserService.getById(UserService.java:42)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â€‹```
```

---

# ğŸ“˜ ç¬¬ä¸‰ç« ï¼šåŸºç¡€æ“ä½œ

## 3.1 æŸ¥è¯¢æ“ä½œ

```markdown
# æŸ¥è¯¢æ“ä½œ

## ä¸€ã€Wrapper æŸ¥è¯¢ï¼ˆæ¨èï¼‰

### 1.1 æŸ¥è¯¢å•æ¡è®°å½•

â€‹```java
// æ–¹å¼ä¸€ï¼šè¿”å› Bean
User user = DB.query(User.class)
    .eq(User::getId, 1)
    .one();

// æ–¹å¼äºŒï¼šè¿”å› ResultMap
ResultMap result = DB.query(User.class)
    .eq(User::getId, 1)
    .oneMap();
â€‹```

### 1.2 æŸ¥è¯¢åˆ—è¡¨

â€‹```java
// æŸ¥è¯¢å…¨éƒ¨
List<User> all = DB.query(User.class).list();

// æ¡ä»¶æŸ¥è¯¢
List<User> users = DB.query(User.class)
    .eq(User::getStatus, 1)
    .gt(User::getAge, 18)
    .orderByDesc(User::getCreateTime)
    .list();
â€‹```

### 1.3 æŸ¥è¯¢æ•°é‡

â€‹```java
long count = DB.query(User.class)
    .eq(User::getStatus, 1)
    .count();
â€‹```

### 1.4 æŸ¥è¯¢æŒ‡å®šå­—æ®µ

â€‹```java
List<User> users = DB.query(User.class)
    .select(User::getId, User::getName, User::getAge)
    .eq(User::getStatus, 1)
    .list();

// ç”Ÿæˆ SQLï¼šSELECT id, name, age FROM user WHERE status = 1
â€‹```

### 1.5 å»é‡æŸ¥è¯¢

â€‹```java
List<String> cities = DB.query(User.class)
    .selectDistinct(User::getCity)
    .list(String.class);
â€‹```

---

## äºŒã€Maker æŸ¥è¯¢ï¼ˆè¡¨åæ–¹å¼ï¼‰

### 2.1 åŸºç¡€æŸ¥è¯¢

â€‹```java
// æŸ¥è¯¢å•æ¡
ResultMap result = DB.query("user")
    .eq("id", 1)
    .one();

// æŸ¥è¯¢åˆ—è¡¨
List<ResultMap> list = DB.query("user")
    .eq("status", 1)
    .list();

// è½¬æ¢ä¸º Bean
List<User> users = DB.query("user")
    .eq("status", 1)
    .list(User.class);
â€‹```

### 2.2 åŠ¨æ€è¡¨å

â€‹```java
String tableName = "user_" + year;  // å¦‚ user_2024

List<ResultMap> list = DB.query(tableName)
    .eq("status", 1)
    .list();
â€‹```

---

## ä¸‰ã€åŸç”Ÿ SQL æŸ¥è¯¢

### 3.1 ä½¿ç”¨å ä½ç¬¦ ?

â€‹```java
// å•ä¸ªç»“æœ
ResultMap result = DB.jdbcSelect(
    "SELECT * FROM user WHERE id = ?", 
    1
).queryOne();

// åˆ—è¡¨ç»“æœ
List<ResultMap> list = DB.jdbcSelect(
    "SELECT * FROM user WHERE status = ? AND age > ?", 
    1, 18
).queryList();

// å•ä¸ªå€¼
String name = DB.jdbcSelect(
    "SELECT name FROM user WHERE id = ?", 
    1
).queryStr();

// å€¼åˆ—è¡¨
List<Long> ids = DB.jdbcSelect(
    "SELECT id FROM user WHERE status = ?", 
    1
).queryList(Long.class);
â€‹```

### 3.2 å¤æ‚æŸ¥è¯¢

â€‹```java
String sql = """
    SELECT u.*, d.name as dept_name
    FROM user u
    LEFT JOIN department d ON u.dept_id = d.id
    WHERE u.status = ? AND d.type = ?
    ORDER BY u.create_time DESC
    """;

List<ResultMap> list = DB.jdbcSelect(sql, 1, "tech").queryList();
â€‹```

---

## å››ã€é¢„è®¾ SQL æŸ¥è¯¢

### 4.1 åŸºç¡€ä½¿ç”¨

â€‹```java
// é€šè¿‡ key è·å–é¢„è®¾ SQL
SqlKeyQuery query = DB.sqlSelect("user.findByCondition");
query.addPara("status", 1);
query.addPara("name", "å¼ ä¸‰");

List<User> users = query.queryList(User.class);
â€‹```

### 4.2 é¢„è®¾ SQL é…ç½®

â€‹```yaml
# sql-config.yml
user.findByCondition: |
  SELECT * FROM user
  WHERE status = #{status}
  [AND name LIKE #{name}]
  [AND age > #{minAge}]
â€‹```

> è¯¦è§ã€Œç¬¬å…«ç« ï¼šé¢„è®¾ SQLã€

---

## äº”ã€ç»“æœå¤„ç†

### 5.1 è¿”å›ç±»å‹

| æ–¹æ³• | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `.one()` | Bean / null | å•æ¡è®°å½•ï¼Œæ— åˆ™è¿”å› null |
| `.oneMap()` | ResultMap / null | å•æ¡è®°å½•ï¼ŒMap å½¢å¼ |
| `.list()` | List<Bean> | åˆ—è¡¨ |
| `.listMap()` | List<ResultMap> | åˆ—è¡¨ï¼ŒMap å½¢å¼ |
| `.count()` | long | æ•°é‡ |
| `.page()` | Page<Bean> | åˆ†é¡µç»“æœ |

### 5.2 ResultMap æ·±åº¦å–å€¼

â€‹```java
ResultMap result = DB.query("user")
    .eq("id", 1)
    .one();

// åŸºç¡€å–å€¼
String name = result.getStr("name");
Integer age = result.getInt("age", 0);  // å¸¦é»˜è®¤å€¼

// æ·±åº¦å–å€¼ï¼ˆå‡è®¾æœ‰åµŒå¥— JSON å­—æ®µï¼‰
String city = result.getStr("address.city", "æœªçŸ¥");
List<Order> orders = result.getList("orders", Order.class);

// è´Ÿæ•°ç´¢å¼•
String lastTag = result.getStr("tags[-1]");  // æœ€åä¸€ä¸ªæ ‡ç­¾
â€‹```
```

---

## 3.2 æ’å…¥æ“ä½œ

```markdown
# æ’å…¥æ“ä½œ

## ä¸€ã€Wrapper æ’å…¥ï¼ˆæ¨èï¼‰

### 1.1 åŸºç¡€æ’å…¥

â€‹```java
User user = new User();
user.setName("å¼ ä¸‰");
user.setAge(25);
user.setEmail("zhangsan@example.com");

// æ’å…¥ï¼ˆä¸è¿”å›ä¸»é”®ï¼‰
DB.insert(user).execute();

// æ’å…¥å¹¶è¿”å›è‡ªå¢ä¸»é”®
Long id = DB.insert(user).insertWithAutoKey();
System.out.println("æ–°ç”¨æˆ· IDï¼š" + id);
â€‹```

### 1.2 æ’å…¥éç©ºå­—æ®µ

â€‹```java
User user = new User();
user.setName("å¼ ä¸‰");
// age å’Œ email ä¸º nullï¼Œä¸ä¼šæ’å…¥

DB.insert(user).execute();

// ç”Ÿæˆ SQLï¼šINSERT INTO user (name) VALUES ('å¼ ä¸‰')
â€‹```

### 1.3 æŒ‡å®šæ’å…¥å­—æ®µ

â€‹```java
User user = new User();
user.setName("å¼ ä¸‰");
user.setAge(25);
user.setEmail("test@test.com");

DB.insert(user)
    .insertFields(User::getName, User::getAge)  // åªæ’å…¥è¿™ä¸¤ä¸ªå­—æ®µ
    .execute();

// ç”Ÿæˆ SQLï¼šINSERT INTO user (name, age) VALUES ('å¼ ä¸‰', 25)
â€‹```

---

## äºŒã€Maker æ’å…¥ï¼ˆè¡¨åæ–¹å¼ï¼‰

### 2.1 åŸºç¡€æ’å…¥

â€‹```java
DB.insert("user")
    .set("name", "å¼ ä¸‰")
    .set("age", 25)
    .set("email", "zhangsan@example.com")
    .set("create_time", new Date())
    .execute();
â€‹```

### 2.2 ä½¿ç”¨ Map æ’å…¥

â€‹```java
Map<String, Object> data = new HashMap<>();
data.put("name", "å¼ ä¸‰");
data.put("age", 25);
data.put("email", "zhangsan@example.com");

DB.insert("user").setMap(data).execute();
â€‹```

### 2.3 è¿”å›è‡ªå¢ä¸»é”®

â€‹```java
Long id = DB.insert("user")
    .set("name", "å¼ ä¸‰")
    .set("age", 25)
    .insertWithAutoKey();
â€‹```

---

## ä¸‰ã€æ‰¹é‡æ’å…¥

### 3.1 æ‰¹é‡æ’å…¥ Bean åˆ—è¡¨

â€‹```java
List<User> users = Arrays.asList(
    new User("å¼ ä¸‰", 25),
    new User("æå››", 30),
    new User("ç‹äº”", 28)
);

DB.insertBatch(users).execute();
â€‹```

### 3.2 æ‰¹é‡æ’å…¥ Map åˆ—è¡¨

â€‹```java
List<Map<String, Object>> dataList = new ArrayList<>();
dataList.add(Map.of("name", "å¼ ä¸‰", "age", 25));
dataList.add(Map.of("name", "æå››", "age", 30));

DB.insertBatch("user", dataList).execute();
â€‹```

---

## å››ã€æ’å…¥æˆ–æ›´æ–°

### 4.1 å­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥

â€‹```java
User user = new User();
user.setId(1L);  // ä¸»é”®
user.setName("å¼ ä¸‰");
user.setAge(26);

DB.insertOrUpdate(user).execute();

// å¦‚æœ id=1 å­˜åœ¨ â†’ UPDATE
// å¦‚æœ id=1 ä¸å­˜åœ¨ â†’ INSERT
â€‹```
```

---

## 3.3 æ›´æ–°æ“ä½œ

```markdown
# æ›´æ–°æ“ä½œ

## ä¸€ã€Wrapper æ›´æ–°ï¼ˆæ¨èï¼‰

### 1.1 æ ¹æ®æ¡ä»¶æ›´æ–°

â€‹```java
User user = new User();
user.setName("æå››");
user.setAge(30);

DB.update(user)
    .eq(User::getId, 1)
    .execute();

// ç”Ÿæˆ SQLï¼š
// UPDATE user SET name='æå››', age=30 
// WHERE id = 1 AND is_deleted = 0
â€‹```

### 1.2 æ›´æ–°æŒ‡å®šå­—æ®µ

â€‹```java
DB.update(User.class)
    .set(User::getName, "æå››")
    .set(User::getUpdateTime, new Date())
    .eq(User::getId, 1)
    .execute();
â€‹```

### 1.3 æ¡ä»¶æ›´æ–°

â€‹```java
DB.update(User.class)
    .set(User::getStatus, 0)
    .eq(User::getType, 1)
    .lt(User::getLastLoginTime, DateUtil.addDays(new Date(), -30))
    .execute();

// å°† 30 å¤©æœªç™»å½•çš„ç”¨æˆ·è®¾ä¸ºç¦ç”¨
â€‹```

---

## äºŒã€Maker æ›´æ–°ï¼ˆè¡¨åæ–¹å¼ï¼‰

### 2.1 åŸºç¡€æ›´æ–°

â€‹```java
DB.update("user")
    .set("name", "æå››")
    .set("update_time", new Date())
    .where(Condition.where()
        .eq("id", 1)
    )
    .execute();
â€‹```

### 2.2 å¤æ‚æ¡ä»¶æ›´æ–°

â€‹```java
DB.update("user")
    .set("status", 1)
    .where(Condition.where()
        .eq("type", 1)
        .and(w -> w
            .eq("level", 3)
            .gt("score", 100)
        )
        .or(w -> w
            .eq("vip", 1)
        )
    )
    .execute();

// ç”Ÿæˆ SQLï¼š
// UPDATE user SET status = 1 
// WHERE type = 1 
//   AND (level = 3 AND score > 100) 
//   OR (vip = 1) 
//   AND is_deleted = 0
â€‹```

### 2.3 è¡¨è¾¾å¼æ›´æ–°

â€‹```java
// æ•°å€¼å¢å‡
DB.update("user")
    .setSql("score = score + 10")
    .setSql("login_count = login_count + 1")
    .eq("id", 1)
    .execute();

// ç”Ÿæˆ SQLï¼š
// UPDATE user SET score = score + 10, login_count = login_count + 1 
// WHERE id = 1
â€‹```

---

## ä¸‰ã€å®‰å…¨æœºåˆ¶

### 3.1 å¿…é¡»æœ‰æ¡ä»¶

â€‹```java
// âŒ æ— æ¡ä»¶æ›´æ–°ä¼šè¢«æ‹¦æˆªæˆ–æ·»åŠ å®‰å…¨æ¡ä»¶
DB.update(User.class)
    .set(User::getStatus, 0)
    .execute();

// ç”Ÿæˆ SQLï¼ˆè‡ªåŠ¨æ·»åŠ  is_deleted æ¡ä»¶ï¼‰ï¼š
// UPDATE user SET status = 0 WHERE is_deleted = 0
// ä¸ä¼šæ›´æ–°å…¨è¡¨ï¼
â€‹```

### 3.2 é€»è¾‘åˆ é™¤è‡ªåŠ¨æ·»åŠ 

â€‹```java
// Bean æœ‰ isDeleted å­—æ®µæ—¶ï¼Œè‡ªåŠ¨æ·»åŠ æ¡ä»¶
DB.update(user).eq(User::getId, 1).execute();

// ç”Ÿæˆ SQLï¼š
// UPDATE user SET ... WHERE id = 1 AND is_deleted = 0
â€‹```
```

---

## 3.4 åˆ é™¤æ“ä½œ

```markdown
# åˆ é™¤æ“ä½œ

## ä¸€ã€Wrapper åˆ é™¤ï¼ˆæ¨èï¼‰

### 1.1 æ¡ä»¶åˆ é™¤

â€‹```java
DB.delete(User.class)
    .eq(User::getId, 1)
    .execute();

// ç”Ÿæˆ SQLï¼ˆé€»è¾‘åˆ é™¤ï¼‰ï¼š
// UPDATE user SET is_deleted = 1 WHERE id = 1 AND is_deleted = 0
// æˆ–ï¼ˆç‰©ç†åˆ é™¤ï¼‰ï¼š
// DELETE FROM user WHERE id = 1 AND is_deleted = 0
â€‹```

### 1.2 å¤æ‚æ¡ä»¶åˆ é™¤

â€‹```java
DB.delete(User.class)
    .eq(User::getStatus, 0)
    .lt(User::getCreateTime, DateUtil.addDays(new Date(), -365))
    .execute();

// åˆ é™¤ä¸€å¹´å‰å·²ç¦ç”¨çš„ç”¨æˆ·
â€‹```

---

## äºŒã€Maker åˆ é™¤ï¼ˆè¡¨åæ–¹å¼ï¼‰

### 2.1 åŸºç¡€åˆ é™¤

â€‹```java
DB.delete("user")
    .eq("id", 1)
    .execute();
â€‹```

### 2.2 å¤æ‚æ¡ä»¶åˆ é™¤

â€‹```java
Condition where = Condition.where()
    .eq("status", 0)
    .and(w -> w.eq("type", 1).eq("level", 0))
    .or(w -> w.lt("expire_time", new Date()));

DB.delete("user").where(where).execute();

// ç”Ÿæˆ SQLï¼š
// DELETE FROM user 
// WHERE status = 0 
//   AND (type = 1 AND level = 0) 
//   OR (expire_time < '2024-01-01') 
//   AND is_deleted = 0
â€‹```

---

## ä¸‰ã€é€»è¾‘åˆ é™¤

### 3.1 è‡ªåŠ¨é€»è¾‘åˆ é™¤

å½“ Bean ä¸­å­˜åœ¨ `isDeleted` å­—æ®µæ—¶ï¼ŒDLZ-DB è‡ªåŠ¨ï¼š

1. **åˆ é™¤æ—¶**ï¼šUPDATE è®¾ç½®åˆ é™¤æ ‡è®°ï¼Œè€ŒéçœŸæ­£ DELETE
2. **æŸ¥è¯¢æ—¶**ï¼šè‡ªåŠ¨æ·»åŠ  `is_deleted = 0` æ¡ä»¶
3. **æ›´æ–°æ—¶**ï¼šè‡ªåŠ¨æ·»åŠ  `is_deleted = 0` æ¡ä»¶

â€‹```java
// æ‰§è¡Œåˆ é™¤
DB.delete(User.class).eq(User::getId, 1).execute();

// å®é™…æ‰§è¡Œçš„ SQLï¼š
// UPDATE user SET is_deleted = 1 WHERE id = 1 AND is_deleted = 0
â€‹```

### 3.2 é…ç½®é€»è¾‘åˆ é™¤

â€‹```yaml
dlz:
  db:
    # é€»è¾‘åˆ é™¤å­—æ®µå
    logic-delete-field: is_deleted
    # å·²åˆ é™¤å€¼
    logic-delete-value: 1
    # æœªåˆ é™¤å€¼
    logic-not-delete-value: 0
â€‹```

### 3.3 ç‰©ç†åˆ é™¤

â€‹```java
// å¦‚æœç¡®å®éœ€è¦ç‰©ç†åˆ é™¤
DB.deletePhysical(User.class)
    .eq(User::getId, 1)
    .execute();

// æ‰§è¡ŒçœŸæ­£çš„ DELETE FROM user WHERE id = 1
â€‹```

---

## å››ã€å®‰å…¨æœºåˆ¶

### 4.1 æ— æ¡ä»¶åˆ é™¤ä¿æŠ¤

â€‹```java
// âŒ æ— æ¡ä»¶åˆ é™¤ä¼šè¢«å®‰å…¨å¤„ç†
DB.delete(User.class).execute();

// ç”Ÿæˆ SQLï¼ˆåªä¼šåˆ é™¤é€»è¾‘æœªåˆ é™¤çš„ï¼‰ï¼š
// DELETE FROM user WHERE is_deleted = 0
// è€Œä¸æ˜¯ DELETE FROM userï¼ˆä¸ä¼šåˆ å…¨è¡¨ï¼‰
â€‹```

### 4.2 åˆ é™¤å‰ç¡®è®¤

â€‹```java
// å…ˆæŸ¥è¯¢æ•°é‡ï¼Œç¡®è®¤å½±å“èŒƒå›´
long count = DB.query(User.class)
    .eq(User::getStatus, 0)
    .lt(User::getCreateTime, someDate)
    .count();

if (count < 1000) {  // ç¡®ä¿ä¸ä¼šè¯¯åˆ å¤ªå¤š
    DB.delete(User.class)
        .eq(User::getStatus, 0)
        .lt(User::getCreateTime, someDate)
        .execute();
}
â€‹```
```

---

# ğŸ“˜ ç¬¬å››ç« ï¼šæ¡ä»¶æ„é€ å™¨

## 4.1 åŸºç¡€æ¡ä»¶

```markdown
# åŸºç¡€æ¡ä»¶

## æ¡ä»¶æ–¹æ³•ä¸€è§ˆ

| æ–¹æ³• | è¯´æ˜ | SQL ç¤ºä¾‹ |
|------|------|---------|
| `eq(å­—æ®µ, å€¼)` | ç­‰äº | `field = value` |
| `ne(å­—æ®µ, å€¼)` | ä¸ç­‰äº | `field <> value` |
| `gt(å­—æ®µ, å€¼)` | å¤§äº | `field > value` |
| `ge(å­—æ®µ, å€¼)` | å¤§äºç­‰äº | `field >= value` |
| `lt(å­—æ®µ, å€¼)` | å°äº | `field < value` |
| `le(å­—æ®µ, å€¼)` | å°äºç­‰äº | `field <= value` |
| `isNull(å­—æ®µ)` | ä¸ºç©º | `field IS NULL` |
| `isNotNull(å­—æ®µ)` | ä¸ä¸ºç©º | `field IS NOT NULL` |

## ä½¿ç”¨ç¤ºä¾‹

### Lambda æ–¹å¼ï¼ˆæ¨èï¼‰

â€‹```java
DB.query(User.class)
    .eq(User::getStatus, 1)       // status = 1
    .ne(User::getType, 0)         // type <> 0
    .gt(User::getAge, 18)         // age > 18
    .ge(User::getScore, 60)       // score >= 60
    .lt(User::getLevel, 10)       // level < 10
    .le(User::getRetryCount, 3)   // retry_count <= 3
    .isNull(User::getDeleteTime)  // delete_time IS NULL
    .isNotNull(User::getEmail)    // email IS NOT NULL
    .list();
â€‹```

### å­—ç¬¦ä¸²æ–¹å¼

â€‹```java
DB.query("user")
    .eq("status", 1)
    .gt("age", 18)
    .isNull("delete_time")
    .list();
â€‹```

## æ¡ä»¶æ‰§è¡Œæ§åˆ¶

### æ¡ä»¶åˆ¤æ–­

â€‹```java
String name = request.getParameter("name");  // å¯èƒ½ä¸º null
Integer status = request.getParameter("status");

DB.query(User.class)
    // ç¬¬ä¸€ä¸ªå‚æ•°ä¸º true æ—¶æ‰æ·»åŠ æ¡ä»¶
    .eq(status != null, User::getStatus, status)
    .like(StringUtil.isNotBlank(name), User::getName, name)
    .list();

// å¦‚æœ name ä¸ºç©ºï¼Œåˆ™ä¸ä¼šæ·»åŠ  LIKE æ¡ä»¶
â€‹```

### é“¾å¼æ¡ä»¶æ§åˆ¶

â€‹```java
WrapperQuery<User> query = DB.query(User.class);

if (status != null) {
    query.eq(User::getStatus, status);
}
if (StringUtil.isNotBlank(name)) {
    query.like(User::getName, name);
}
if (minAge != null) {
    query.ge(User::getAge, minAge);
}

List<User> users = query.list();
â€‹```
```

---

## 4.2 é€»è¾‘ç»„åˆ

```markdown
# é€»è¾‘ç»„åˆï¼ˆAND / ORï¼‰

## é»˜è®¤é€»è¾‘

å¤šä¸ªæ¡ä»¶é»˜è®¤ä½¿ç”¨ **AND** è¿æ¥ï¼š

â€‹```java
DB.query(User.class)
    .eq(User::getStatus, 1)
    .gt(User::getAge, 18)
    .like(User::getName, "å¼ ")
    .list();

// ç”Ÿæˆ SQLï¼š
// WHERE status = 1 AND age > 18 AND name LIKE '%å¼ %'
â€‹```

## OR æ¡ä»¶

### ç®€å• OR

â€‹```java
DB.query(User.class)
    .eq(User::getStatus, 1)
    .or(w -> w
        .eq(User::getType, 1)
        .eq(User::getType, 2)
    )
    .list();

// ç”Ÿæˆ SQLï¼š
// WHERE status = 1 AND (type = 1 OR type = 2)
â€‹```

### å¤æ‚ OR

â€‹```java
DB.query(User.class)
    .or(w -> w
        .eq(User::getCity, "åŒ—äº¬")
        .eq(User::getCity, "ä¸Šæµ·")
        .eq(User::getCity, "å¹¿å·")
    )
    .gt(User::getAge, 18)
    .list();

// ç”Ÿæˆ SQLï¼š
// WHERE (city = 'åŒ—äº¬' OR city = 'ä¸Šæµ·' OR city = 'å¹¿å·') AND age > 18
â€‹```

## AND åµŒå¥—

â€‹```java
DB.query(User.class)
    .eq(User::getStatus, 1)
    .and(w -> w
        .gt(User::getAge, 18)
        .lt(User::getAge, 60)
    )
    .list();

// ç”Ÿæˆ SQLï¼š
// WHERE status = 1 AND (age > 18 AND age < 60)
â€‹```

## æ··åˆåµŒå¥—

### ç¤ºä¾‹1ï¼šå¤æ‚ä¸šåŠ¡æ¡ä»¶

â€‹```java
// åœºæ™¯ï¼šæŸ¥è¯¢ (çŠ¶æ€æ­£å¸¸) ä¸” (VIPç”¨æˆ· æˆ– (æ™®é€šç”¨æˆ·ä¸”ç§¯åˆ†>100))
DB.query(User.class)
    .eq(User::getStatus, 1)
    .and(w -> w
        .eq(User::getVip, 1)
        .or(o -> o
            .eq(User::getVip, 0)
            .gt(User::getScore, 100)
        )
    )
    .list();

// ç”Ÿæˆ SQLï¼š
// WHERE status = 1 AND (vip = 1 OR (vip = 0 AND score > 100))
â€‹```

### ç¤ºä¾‹2ï¼šèœå•é‡å¤æ£€æŸ¥

â€‹```java
Menu menu = new Menu();
menu.setId(100L);
menu.setCode("user_mgmt");
menu.setName("ç”¨æˆ·ç®¡ç†");

WrapperQuery<Menu> query = DB.query(Menu.class);

// æ’é™¤è‡ªå·±
if (menu.getId() != null) {
    query.ne(Menu::getId, menu.getId());
}

// ç¼–ç ç›¸åŒ OR (åç§°ç›¸åŒ AND åˆ†ç±»ç›¸åŒ)
query.or(w -> w
    .eq(Menu::getCode, menu.getCode())
    .and(a -> a
        .eq(Menu::getName, menu.getName())
        .eq(Menu::getCategory, "1")
    )
);

boolean exists = query.count() > 0;

// ç”Ÿæˆ SQLï¼š
// WHERE id <> 100 
//   AND (code = 'user_mgmt' OR (name = 'ç”¨æˆ·ç®¡ç†' AND category = '1')) 
//   AND is_deleted = 0
â€‹```

## ä½¿ç”¨ Condition å¤ç”¨æ¡ä»¶

â€‹```java
// åˆ›å»ºå¯å¤ç”¨çš„æ¡ä»¶
Condition baseCondition = Condition.where()
    .eq("status", 1)
    .gt("age", 18);

Condition vipCondition = Condition.where()
    .eq("vip", 1)
    .gt("level", 5);

// åº”ç”¨åˆ°æŸ¥è¯¢
DB.query("user")
    .where(baseCondition)
    .or(w -> w.where(vipCondition))
    .list();

// åº”ç”¨åˆ°æ›´æ–°
DB.update("user")
    .set("flag", 1)
    .where(baseCondition)
    .execute();
â€‹```
```

---

## 4.3 æ¨¡ç³ŠæŸ¥è¯¢

```markdown
# æ¨¡ç³ŠæŸ¥è¯¢

## LIKE æŸ¥è¯¢

| æ–¹æ³• | è¯´æ˜ | SQL ç¤ºä¾‹ |
|------|------|---------|
| `like(å­—æ®µ, å€¼)` | åŒ…å« | `LIKE '%å€¼%'` |
| `likeLeft(å­—æ®µ, å€¼)` | å·¦æ¨¡ç³Š | `LIKE '%å€¼'` |
| `likeRight(å­—æ®µ, å€¼)` | å³æ¨¡ç³Š | `LIKE 'å€¼%'` |
| `notLike(å­—æ®µ, å€¼)` | ä¸åŒ…å« | `NOT LIKE '%å€¼%'` |

## ä½¿ç”¨ç¤ºä¾‹

â€‹```java
DB.query(User.class)
    // åå­—åŒ…å«"å¼ "
    .like(User::getName, "å¼ ")
    // é‚®ç®±ä»¥ @gmail.com ç»“å°¾
    .likeLeft(User::getEmail, "@gmail.com")
    // æ‰‹æœºå·ä»¥ 138 å¼€å¤´
    .likeRight(User::getPhone, "138")
    // åœ°å€ä¸åŒ…å«"æµ‹è¯•"
    .notLike(User::getAddress, "æµ‹è¯•")
    .list();

// ç”Ÿæˆ SQLï¼š
// WHERE name LIKE '%å¼ %' 
//   AND email LIKE '%@gmail.com' 
//   AND phone LIKE '138%' 
//   AND address NOT LIKE '%æµ‹è¯•%'
â€‹```

## æ¡ä»¶åˆ¤æ–­

â€‹```java
String keyword = request.getParameter("keyword");

DB.query(User.class)
    // keyword ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ  LIKE æ¡ä»¶
    .like(StringUtil.isNotBlank(keyword), User::getName, keyword)
    .list();
â€‹```

## æ³¨æ„äº‹é¡¹

1. **ç©ºå€¼å¤„ç†**ï¼šå½“å€¼ä¸º null æˆ–ç©ºå­—ç¬¦ä¸²æ—¶ï¼Œå»ºè®®è·³è¿‡æ¡ä»¶
2. **æ€§èƒ½è€ƒè™‘**ï¼š`likeLeft`ï¼ˆå·¦æ¨¡ç³Šï¼‰æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œå¤§æ•°æ®é‡æ—¶æ…ç”¨
3. **ç‰¹æ®Šå­—ç¬¦**ï¼šæ¡†æ¶ä¼šè‡ªåŠ¨è½¬ä¹‰ `%` å’Œ `_` ç­‰ç‰¹æ®Šå­—ç¬¦
```

---

## 4.4 èŒƒå›´æŸ¥è¯¢

```markdown
# èŒƒå›´æŸ¥è¯¢

## IN æŸ¥è¯¢

### åŸºç¡€ IN

â€‹```java
DB.query(User.class)
    .in(User::getId, Arrays.asList(1, 2, 3, 4, 5))
    .list();

// ç”Ÿæˆ SQLï¼šWHERE id IN (1, 2, 3, 4, 5)
â€‹```

### å­—ç¬¦ä¸² INï¼ˆè‡ªåŠ¨è§£æï¼‰

â€‹```java
// æ–¹å¼1ï¼šé€—å·åˆ†éš”çš„æ•°å­—
DB.query(User.class)
    .in(User::getId, "1,2,3,4,5")
    .list();
// ç”Ÿæˆ SQLï¼šWHERE id IN (1,2,3,4,5)

// æ–¹å¼2ï¼šå¸¦å¼•å·çš„å­—ç¬¦ä¸²
DB.query(User.class)
    .in(User::getCode, "'A','B','C'")
    .list();
// ç”Ÿæˆ SQLï¼šWHERE code IN ('A','B','C')

// æ–¹å¼3ï¼šæ··åˆç±»å‹
DB.query(User.class)
    .in(User::getCode, "'A',111,'B',222")
    .list();
// ç”Ÿæˆ SQLï¼šWHERE code IN ('A','111','B','222')
â€‹```

### å­æŸ¥è¯¢ IN

â€‹```java
DB.query(User.class)
    .in(User::getDeptId, "sql:SELECT id FROM department WHERE status = 1")
    .list();

// ç”Ÿæˆ SQLï¼šWHERE dept_id IN (SELECT id FROM department WHERE status = 1)
â€‹```

### NOT IN

â€‹```java
DB.query(User.class)
    .notIn(User::getStatus, Arrays.asList(0, -1))
    .list();

// ç”Ÿæˆ SQLï¼šWHERE status NOT IN (0, -1)
â€‹```

## BETWEEN æŸ¥è¯¢

â€‹```java
DB.query(User.class)
    .between(User::getAge, 18, 30)
    .between(User::getCreateTime, startDate, endDate)
    .list();

// ç”Ÿæˆ SQLï¼š
// WHERE age BETWEEN 18 AND 30 
//   AND create_time BETWEEN '2024-01-01' AND '2024-12-31'
â€‹```

## NOT BETWEEN

â€‹```java
DB.query(User.class)
    .notBetween(User::getScore, 0, 60)
    .list();

// ç”Ÿæˆ SQLï¼šWHERE score NOT BETWEEN 0 AND 60
â€‹```

## ç»¼åˆç¤ºä¾‹

â€‹```java
// æŸ¥è¯¢æ¡ä»¶ï¼š
// - ID åœ¨åˆ—è¡¨ä¸­
// - çŠ¶æ€ä¸åœ¨ç¦ç”¨åˆ—è¡¨
// - å¹´é¾„åœ¨ 18-60 ä¹‹é—´
// - éƒ¨é—¨åœ¨å­æŸ¥è¯¢ç»“æœä¸­

DB.query(User.class)
    .in(User::getId, "1,2,3,4,5")
    .notIn(User::getStatus, Arrays.asList(0, -1))
    .between(User::getAge, 18, 60)
    .in(User::getDeptId, "sql:SELECT id FROM dept WHERE type = 'tech'")
    .list();
â€‹```
```

---

## 4.5 è‡ªå®šä¹‰ SQL

```markdown
# è‡ªå®šä¹‰ SQL

## apply æ–¹æ³•ï¼ˆå ä½ç¬¦æ–¹å¼ï¼‰

ä½¿ç”¨ `{0}`, `{1}`, `{2}` ä½œä¸ºå ä½ç¬¦ï¼š

â€‹```java
DB.query(User.class)
    .eq(User::getStatus, 1)
    .apply("age > {0} AND age < {1}", 18, 60)
    .list();

// ç”Ÿæˆ SQLï¼š
// WHERE status = 1 AND (age > 18 AND age < 60)
â€‹```

### å­æŸ¥è¯¢ç¤ºä¾‹

â€‹```java
DB.query(User.class)
    .apply("id IN (SELECT user_id FROM orders WHERE amount > {0})", 1000)
    .list();

// ç”Ÿæˆ SQLï¼š
// WHERE (id IN (SELECT user_id FROM orders WHERE amount > 1000))
â€‹```

### EXISTS ç¤ºä¾‹

â€‹```java
DB.query(User.class)
    .eq(User::getStatus, 1)
    .apply("EXISTS (SELECT 1 FROM vip WHERE user_id = t.id AND level >= {0})", 3)
    .list();
â€‹```

## sql æ–¹æ³•ï¼ˆå‘½åå‚æ•°æ–¹å¼ï¼‰

ä½¿ç”¨ `#{å‚æ•°å}` ä½œä¸ºå‘½åå‚æ•°ï¼š

â€‹```java
JSONMap params = new JSONMap("minAge", 18, "maxAge", 60);

DB.query(User.class)
    .eq(User::getStatus, 1)
    .sql("age > #{minAge} AND age < #{maxAge}", params)
    .list();

// ç”Ÿæˆ SQLï¼š
// WHERE status = 1 AND (age > 18 AND age < 60)
â€‹```

### å¤æ‚å­æŸ¥è¯¢ç¤ºä¾‹

â€‹```java
JSONMap params = new JSONMap();
params.put("level", 3);
params.put("minAmount", 1000);

DB.query(User.class)
    .sql("EXISTS (SELECT 1 FROM orders o WHERE o.user_id = t.id AND o.amount > #{minAmount})", params)
    .sql("id IN (SELECT user_id FROM vip WHERE level >= #{level})", params)
    .list();
â€‹```

## å¯é€‰æ¡ä»¶ï¼ˆæ–¹æ‹¬å·è¯­æ³•ï¼‰

å½“å‚æ•°ä¸ºç©ºæ—¶ï¼Œæ•´ä¸ªæ¡ä»¶è‡ªåŠ¨å¿½ç•¥ï¼š

â€‹```java
String name = null;  // å‰ç«¯æœªä¼ 
Integer minAge = 18;

DB.delete("user")
    .apply("[name = {0}]", name)      // name ä¸ºç©ºï¼Œå¿½ç•¥æ­¤æ¡ä»¶
    .apply("[age >= {0}]", minAge)    // minAge æœ‰å€¼ï¼Œæ¡ä»¶ç”Ÿæ•ˆ
    .execute();

// ç”Ÿæˆ SQLï¼š
// DELETE FROM user WHERE (age >= 18) AND is_deleted = 0
â€‹```

### sql æ–¹æ³•åŒæ ·æ”¯æŒ

â€‹```java
JSONMap params = new JSONMap();
params.put("name", null);
params.put("age", 18);

DB.query("user")
    .sql("[name = #{name}]", params)  // å¿½ç•¥
    .sql("[age >= #{age}]", params)   // ç”Ÿæ•ˆ
    .list();
â€‹```

## åœ¨ Condition ä¸­ä½¿ç”¨

â€‹```java
Condition condition = Condition.where()
    .eq("status", 1)
    .sql("score > #{minScore}", new JSONMap("minScore", 60))
    .apply("create_time > {0}", someDate);

DB.query("user").where(condition).list();
DB.update("user").set("flag", 1).where(condition).execute();
â€‹```

## å®‰å…¨æç¤º

â€‹```java
// âœ… å®‰å…¨ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
.apply("name = {0}", userInput)
.sql("name = #{name}", params)

// âš ï¸ å±é™©ï¼šç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥
.apply("name = '" + userInput + "'")  // å¯èƒ½ SQL æ³¨å…¥ï¼
â€‹```
```

---

# ğŸ“˜ ç¬¬äº”ç« ï¼šåˆ†é¡µæ’åº

## 5.1 åˆ†é¡µæŸ¥è¯¢

```markdown
# åˆ†é¡µæŸ¥è¯¢

## åˆ›å»ºåˆ†é¡µå‚æ•°

â€‹```java
// åŸºç¡€åˆ†é¡µ
Page page = Page.build(1, 10);  // ç¬¬1é¡µï¼Œæ¯é¡µ10æ¡

// å¸¦æ’åºçš„åˆ†é¡µ
Page page = Page.build(1, 10, Order.desc("create_time"));

// å¤šå­—æ®µæ’åº
Page page = Page.build(1, 10, Order.desc("create_time"), Order.asc("id"));
â€‹```

## Wrapper åˆ†é¡µ

â€‹```java
// åˆ†é¡µæŸ¥è¯¢
Page<User> result = DB.query(User.class)
    .eq(User::getStatus, 1)
    .page(Page.build(1, 10))
    .page();

// è·å–æ•°æ®
List<User> records = result.getRecords();  // å½“å‰é¡µæ•°æ®
long total = result.getTotal();            // æ€»æ¡æ•°
int pages = result.getPages();             // æ€»é¡µæ•°
int current = result.getCurrent();         // å½“å‰é¡µ
int size = result.getSize();               // æ¯é¡µæ¡æ•°
â€‹```

## åŸç”Ÿ SQL åˆ†é¡µ

â€‹```java
Page<ResultMap> result = DB.jdbcSelect(
    "SELECT * FROM user WHERE status = ?", 1
).page(Page.build(1, 10)).pageQuery();

// ç”Ÿæˆ SQLï¼š
// SELECT * FROM user WHERE status = 1 LIMIT 0, 10
// ï¼ˆåŒæ—¶æ‰§è¡Œ COUNT æŸ¥è¯¢è·å–æ€»æ•°ï¼‰
â€‹```

## é¢„è®¾ SQL åˆ†é¡µ

â€‹```java
SqlKeyQuery query = DB.sqlSelect("user.findByCondition");
query.addPara("status", 1);
query.setPage(Page.build(1, 10, Order.desc("id")));

Page<User> result = query.pageQuery(User.class);
â€‹```

## ä»…æ’åºä¸åˆ†é¡µ

â€‹```java
// åªéœ€è¦æ’åºï¼Œä¸éœ€è¦åˆ†é¡µ
List<User> users = DB.jdbcSelect("SELECT * FROM user WHERE status = ?", 1)
    .page(Page.build(Order.descs("create_time", "id")))  // ä¸ä¼ é¡µç 
    .queryList(User.class);

// ç”Ÿæˆ SQLï¼š
// SELECT * FROM user WHERE status = 1 
// ORDER BY create_time DESC, id DESC
// ï¼ˆæ—  LIMITï¼‰
â€‹```

## åˆ†é¡µç»“æœå¯¹è±¡

â€‹```java
Page<User> page = ...;

// å¸¸ç”¨æ–¹æ³•
page.getRecords()    // List<User> å½“å‰é¡µæ•°æ®
page.getTotal()      // long æ€»æ¡æ•°
page.getPages()      // int æ€»é¡µæ•°
page.getCurrent()    // int å½“å‰é¡µç 
page.getSize()       // int æ¯é¡µæ¡æ•°
page.hasNext()       // boolean æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
page.hasPrevious()   // boolean æ˜¯å¦æœ‰ä¸Šä¸€é¡µ
â€‹```
```

---

## 5.2 æ’åº

```markdown
# æ’åº

## åˆ›å»ºæ’åºå¯¹è±¡

â€‹```java
// å•å­—æ®µå‡åº
Order.asc("create_time")

// å•å­—æ®µé™åº
Order.desc("create_time")

// å¤šå­—æ®µå‡åº
Order.ascs("status", "create_time")

// å¤šå­—æ®µé™åº
Order.descs("create_time", "id")
â€‹```

## Wrapper æ’åº

â€‹```java
DB.query(User.class)
    .eq(User::getStatus, 1)
    .orderByAsc(User::getLevel)
    .orderByDesc(User::getCreateTime)
    .list();

// ç”Ÿæˆ SQLï¼š
// ... ORDER BY level ASC, create_time DESC
â€‹```

## åŠ¨æ€æ’åº

â€‹```java
String sortField = request.getParameter("sort");      // å¦‚ "create_time"
String sortOrder = request.getParameter("order");     // å¦‚ "desc"

Order order = "desc".equals(sortOrder) 
    ? Order.desc(sortField) 
    : Order.asc(sortField);

DB.query(User.class)
    .page(Page.build(1, 10, order))
    .page();
â€‹```

## å®‰å…¨æ’åºï¼ˆç™½åå•ï¼‰

â€‹```java
// é˜²æ­¢ SQL æ³¨å…¥ï¼Œåªå…è®¸ç‰¹å®šå­—æ®µæ’åº
Set<String> allowedFields = Set.of("id", "name", "create_time", "update_time");

String sortField = request.getParameter("sort");
if (!allowedFields.contains(sortField)) {
    sortField = "create_time";  // é»˜è®¤æ’åºå­—æ®µ
}

Order order = Order.desc(sortField);
â€‹```

## å¤šå­—æ®µæ’åº

â€‹```java
// æ–¹å¼1ï¼šOrder å¯¹è±¡
Page page = Page.build(1, 10, 
    Order.desc("status"),
    Order.desc("create_time"),
    Order.asc("id")
);

// æ–¹å¼2ï¼šWrapper é“¾å¼
DB.query(User.class)
    .orderByDesc(User::getStatus)
    .orderByDesc(User::getCreateTime)
    .orderByAsc(User::getId)
    .list();

// ç”Ÿæˆ SQLï¼š
// ORDER BY status DESC, create_time DESC, id ASC
â€‹```

## NULL å€¼æ’åº

â€‹```java
// è‡ªå®šä¹‰ SQL å¤„ç† NULL æ’åº
DB.query(User.class)
    .orderBySql("IFNULL(sort_num, 999999) ASC")
    .orderByDesc(User::getCreateTime)
    .list();
â€‹```
```

---

# ğŸ“˜ ç¬¬å…­ç« ï¼šç»“æœæ˜ å°„

## 6.1 Bean æ˜ å°„

```markdown
# Bean æ˜ å°„

## è‡ªåŠ¨æ˜ å°„è§„åˆ™

DLZ-DB è‡ªåŠ¨å°†æ•°æ®åº“å­—æ®µæ˜ å°„åˆ° Bean å±æ€§ï¼š

| æ•°æ®åº“å­—æ®µ | Bean å±æ€§ | è¯´æ˜ |
|-----------|-----------|------|
| `user_name` | `userName` | ä¸‹åˆ’çº¿è½¬é©¼å³° |
| `USER_NAME` | `userName` | å¤§å†™ä¸‹åˆ’çº¿è½¬é©¼å³° |
| `username` | `username` | ç›´æ¥åŒ¹é… |

## å®šä¹‰å®ä½“ç±»

â€‹```java
@Data
@Table("sys_user")  // æŒ‡å®šè¡¨åï¼ˆå¯é€‰ï¼‰
public class User {
    
    private Long id;
    
    private String userName;  // å¯¹åº” user_name
    
    private Integer age;
    
    @Column("email_address")  // æŒ‡å®šåˆ—å
    private String email;
    
    private Date createTime;  // å¯¹åº” create_time
    
    @Ignore  // å¿½ç•¥æ­¤å­—æ®µï¼Œä¸æ˜ å°„
    private String tempData;
}
â€‹```

## æŸ¥è¯¢æ˜ å°„

â€‹```java
// å•æ¡æ˜ å°„
User user = DB.query(User.class)
    .eq(User::getId, 1)
    .one();

// åˆ—è¡¨æ˜ å°„
List<User> users = DB.query(User.class)
    .eq(User::getStatus, 1)
    .list();

// åŸç”Ÿ SQL æ˜ å°„
User user = DB.jdbcSelect("SELECT * FROM user WHERE id = ?", 1)
    .queryOne(User.class);

// åˆ—è¡¨æ˜ å°„
List<User> users = DB.jdbcSelect("SELECT * FROM user WHERE status = ?", 1)
    .queryList(User.class);
â€‹```

## å¤æ‚ç±»å‹æ˜ å°„

â€‹```java
@Data
public class UserDTO {
    private Long id;
    private String name;
    
    // åµŒå¥—å¯¹è±¡ï¼ˆå‡è®¾æŸ¥è¯¢ç»“æœæœ‰ dept_id, dept_nameï¼‰
    private Department dept;
    
    // JSON å­—æ®µè‡ªåŠ¨è§£æ
    private List<String> tags;
    
    // Map ç±»å‹
    private Map<String, Object> extra;
}

// æŸ¥è¯¢æ—¶è‡ªåŠ¨æ˜ å°„
UserDTO dto = DB.jdbcSelect("""
    SELECT u.*, d.id as dept_id, d.name as dept_name
    FROM user u
    LEFT JOIN department d ON u.dept_id = d.id
    WHERE u.id = ?
    """, 1).queryOne(UserDTO.class);
â€‹```
```

---

## 6.2 Map æ˜ å°„

```markdown
# Map æ˜ å°„

## ResultMap

> DLZ-DB çš„æŸ¥è¯¢ç»“æœé»˜è®¤è¿”å› `ResultMap`ï¼Œå®ƒç»§æ‰¿è‡ª `JSONMap`ï¼Œå…·æœ‰å¼ºå¤§çš„å–å€¼èƒ½åŠ›ã€‚

â€‹```java
// æŸ¥è¯¢è¿”å› ResultMap
ResultMap result = DB.query("user")
    .eq("id", 1)
    .one();

// åŸºç¡€å–å€¼
Long id = result.getLong("id");
String name = result.getStr("name");
Integer age = result.getInt("age", 0);  // å¸¦é»˜è®¤å€¼
Date createTime = result.getDate("create_time");
â€‹```

## åˆ—è¡¨æŸ¥è¯¢

â€‹```java
// è¿”å› ResultMap åˆ—è¡¨
List<ResultMap> list = DB.query("user")
    .eq("status", 1)
    .listMap();

// éå†å¤„ç†
for (ResultMap item : list) {
    String name = item.getStr("name");
    Integer age = item.getInt("age");
}

// è½¬æ¢ä¸º Bean åˆ—è¡¨
List<User> users = list.stream()
    .map(m -> m.toBean(User.class))
    .collect(Collectors.toList());
â€‹```

## ä¸éœ€è¦å®šä¹‰å®ä½“ç±»çš„åœºæ™¯

â€‹```java
// æŠ¥è¡¨ç»Ÿè®¡ï¼šä¸éœ€è¦ä¸ºæ¯ä¸ªæŠ¥è¡¨å®šä¹‰ DTO
ResultMap stats = DB.jdbcSelect("""
    SELECT 
        COUNT(*) as total,
        SUM(amount) as total_amount,
        AVG(amount) as avg_amount,
        MAX(amount) as max_amount
    FROM orders
    WHERE create_time >= ?
    """, startDate).queryOne();

long total = stats.getLong("total");
BigDecimal totalAmount = stats.getBigDecimal("total_amount");
BigDecimal avgAmount = stats.getBigDecimal("avg_amount");
â€‹```
```

---

## 6.3 ResultMap æ·±åº¦å–å€¼

```markdown
# ResultMap æ·±åº¦å–å€¼

## æ ¸å¿ƒèƒ½åŠ›

ResultMap ç»§æ‰¿è‡ª JSONMapï¼Œæ”¯æŒï¼š
1. **æ·±åº¦è·¯å¾„å–å€¼**ï¼š`a.b.c[0].d`
2. **è´Ÿæ•°ç´¢å¼•**ï¼š`list[-1]` è·å–æœ€åä¸€ä¸ªå…ƒç´ 
3. **æ™ºèƒ½ç±»å‹è½¬æ¢**ï¼šè‡ªåŠ¨è½¬æ¢ä¸ºç›®æ ‡ç±»å‹
4. **ç©ºå€¼å®‰å…¨**ï¼šä¸­é—´ä»»æ„èŠ‚ç‚¹ä¸ºç©ºä¸ä¼šæŠ¥é”™
5. **åµŒå¥— JSON å­—ç¬¦ä¸²è§£æ**ï¼šè‡ªåŠ¨è§£æ

## æ·±åº¦å–å€¼

â€‹```java
ResultMap result = DB.jdbcSelect("SELECT * FROM user WHERE id = 1").queryOne();

// å‡è®¾è¿”å›çš„æ•°æ®ç»“æ„ï¼š
// {
//   "id": 1,
//   "name": "å¼ ä¸‰",
//   "profile": {
//     "address": {
//       "city": "åŒ—äº¬",
//       "district": "æœé˜³åŒº"
//     },
//     "tags": ["å¼€å‘è€…", "æ¶æ„å¸ˆ", "DBA"]
//   },
//   "orders": [
//     {"id": 101, "amount": 100},
//     {"id": 102, "amount": 200}
//   ]
// }

// æ·±åº¦å–å€¼
String city = result.getStr("profile.address.city");           // "åŒ—äº¬"
String district = result.getStr("profile.address.district");   // "æœé˜³åŒº"

// æ•°ç»„å–å€¼
String firstTag = result.getStr("profile.tags[0]");            // "å¼€å‘è€…"
String lastTag = result.getStr("profile.tags[-1]");            // "DBA"ï¼ˆè´Ÿæ•°ç´¢å¼•ï¼‰

// åµŒå¥—å¯¹è±¡å–å€¼
Long orderId = result.getLong("orders[0].id");                 // 101
BigDecimal amount = result.getBigDecimal("orders[-1].amount"); // 200
â€‹```

## é»˜è®¤å€¼

â€‹```java
// è·¯å¾„ä¸å­˜åœ¨æ—¶è¿”å›é»˜è®¤å€¼ï¼Œä¸ä¼šæŠ¥ç©ºæŒ‡é’ˆ
String city = result.getStr("profile.address.city", "æœªçŸ¥");
Integer score = result.getInt("score", 0);
List<String> tags = result.getList("profile.tags", String.class, Collections.emptyList());
â€‹```

## ç±»å‹è½¬æ¢

â€‹```java
// è‡ªåŠ¨ç±»å‹è½¬æ¢
Integer age = result.getInt("age");             // æ•°å­— â†’ Integer
Long id = result.getLong("id");                 // æ•°å­— â†’ Long
Double score = result.getDouble("score");       // æ•°å­— â†’ Double
BigDecimal amount = result.getBigDecimal("amount");
Boolean active = result.getBoolean("active");   // æ”¯æŒ true/false, 1/0, "true"/"false"
Date createTime = result.getDate("create_time");

// è·å–åµŒå¥—å¯¹è±¡
ResultMap profile = result.getMap("profile");
ResultMap address = result.getMap("profile.address");

// è·å–åˆ—è¡¨
List<String> tags = result.getList("profile.tags", String.class);
List<Order> orders = result.getList("orders", Order.class);

// è½¬æ¢ä¸º Bean
User user = result.toBean(User.class);
Address addr = result.getBean("profile.address", Address.class);
â€‹```

## åµŒå¥— JSON å­—ç¬¦ä¸²

â€‹```java
// å‡è®¾ config å­—æ®µå­˜å‚¨çš„æ˜¯ JSON å­—ç¬¦ä¸²ï¼š
// {"theme": "dark", "language": "zh"}

// ä¼ ç»Ÿæ–¹å¼éœ€è¦å…ˆè§£æå­—ç¬¦ä¸²
String configStr = result.getStr("config");
JSONObject config = JSON.parseObject(configStr);
String theme = config.getString("theme");

// ResultMap è‡ªåŠ¨è§£æ
String theme = result.getStr("config.theme");   // ç›´æ¥è·å–
ResultMap config = result.getMap("config");     // è·å–ä¸º Map
â€‹```

## ä¸ ValUtil é…åˆ

â€‹```java
ResultMap result = ...;

// è·å–åŸå§‹å€¼
Object raw = result.get("some_field");

// ä½¿ç”¨ ValUtil è½¬æ¢
Integer num = ValUtil.toInt(raw, 0);
List<String> list = ValUtil.toList(raw, String.class);
User user = ValUtil.toObj(raw, User.class);
â€‹```
```

---

# ğŸ“˜ ç¬¬ä¸ƒç« ï¼šLambda è¡¨è¾¾å¼

## 7.1 ç±»å‹å®‰å…¨çš„å­—æ®µå¼•ç”¨

```markdown
# Lambda è¡¨è¾¾å¼

## ä¸ºä»€ä¹ˆä½¿ç”¨ Lambdaï¼Ÿ

â€‹```java
// âŒ å­—ç¬¦ä¸²æ–¹å¼ï¼šé‡æ„æ—¶å®¹æ˜“é—æ¼ï¼ŒIDE æ— æ³•æ£€æŸ¥
.eq("user_name", "å¼ ä¸‰")

// âœ… Lambda æ–¹å¼ï¼šç¼–è¯‘æœŸæ£€æŸ¥ï¼ŒIDE è‡ªåŠ¨è¡¥å…¨
.eq(User::getUserName, "å¼ ä¸‰")
â€‹```

## ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | å­—ç¬¦ä¸²æ–¹å¼ | Lambda æ–¹å¼ |
|------|-----------|-------------|
| IDE è¡¥å…¨ | âŒ | âœ… |
| ç¼–è¯‘æ£€æŸ¥ | âŒ | âœ… |
| é‡æ„å®‰å…¨ | âŒ | âœ… |
| å­—æ®µè·³è½¬ | âŒ | âœ… |

## ä½¿ç”¨æ–¹å¼

### æŸ¥è¯¢

â€‹```java
DB.query(User.class)
    .select(User::getId, User::getName, User::getAge)
    .eq(User::getStatus, 1)
    .gt(User::getAge, 18)
    .like(User::getName, "å¼ ")
    .orderByDesc(User::getCreateTime)
    .list();
â€‹```

### æ›´æ–°

â€‹```java
DB.update(User.class)
    .set(User::getStatus, 0)
    .set(User::getUpdateTime, new Date())
    .eq(User::getId, 1)
    .execute();
â€‹```

### åˆ é™¤

â€‹```java
DB.delete(User.class)
    .eq(User::getId, 1)
    .execute();
â€‹```

### æ’å…¥æŒ‡å®šå­—æ®µ

â€‹```java
DB.insert(user)
    .insertFields(User::getName, User::getAge, User::getEmail)
    .execute();
â€‹```

## å­—æ®µåè§£æè§„åˆ™

â€‹```java
// Lambda è¡¨è¾¾å¼è‡ªåŠ¨è§£æä¸ºæ•°æ®åº“å­—æ®µå
User::getUserName  â†’  user_name  ï¼ˆé©¼å³°è½¬ä¸‹åˆ’çº¿ï¼‰
User::getId        â†’  id
User::getCreateTime â†’ create_time

// å¦‚æœæœ‰ @Column æ³¨è§£ï¼Œä½¿ç”¨æ³¨è§£å€¼
@Column("email_address")
private String email;
User::getEmail     â†’  email_address
â€‹```

## æ··åˆä½¿ç”¨

â€‹```java
// Lambda å’Œå­—ç¬¦ä¸²å¯ä»¥æ··åˆä½¿ç”¨
DB.query(User.class)
    .eq(User::getStatus, 1)           // Lambda
    .apply("create_time > {0}", date) // è‡ªå®šä¹‰ SQL
    .sql("score >= #{min}", params)   // å‘½åå‚æ•°
    .list();
â€‹```
```

---

# ğŸ“˜ ç¬¬å…«ç« ï¼šé¢„è®¾ SQL

## 8.1 Key-SQL æ¦‚å¿µ

```markdown
# é¢„è®¾ SQLï¼ˆKey-SQLï¼‰

## ä»€ä¹ˆæ˜¯é¢„è®¾ SQLï¼Ÿ

é¢„è®¾ SQL æ˜¯å°† SQL è¯­å¥é¢„å…ˆå®šä¹‰å¥½ï¼Œé€šè¿‡å”¯ä¸€çš„ key æ¥è°ƒç”¨ã€‚

**ä¼˜åŠ¿ï¼š**
1. SQL é›†ä¸­ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤
2. æ”¯æŒåŠ¨æ€æ¡ä»¶ï¼Œçµæ´»ç»„è£…
3. å¯åœ¨æ•°æ®åº“ä¸­åœ¨çº¿ç¼–è¾‘ï¼Œæ— éœ€é‡å¯
4. æ”¯æŒ SQL åµŒå¥—å¤ç”¨

## é…ç½®æ–¹å¼

### æ–¹å¼ä¸€ï¼šé…ç½®æ–‡ä»¶

â€‹```yaml
# sql-config.yml
dlz:
  sql:
    user.findAll: |
      SELECT * FROM user WHERE is_deleted = 0
      
    user.findByCondition: |
      SELECT * FROM user 
      WHERE is_deleted = 0
      [AND status = #{status}]
      [AND name LIKE CONCAT('%', #{name}, '%')]
      [AND age >= #{minAge}]
      [AND age <= #{maxAge}]
      ORDER BY create_time DESC
      
    order.statistics: |
      SELECT 
        DATE(create_time) as date,
        COUNT(*) as count,
        SUM(amount) as total
      FROM orders
      WHERE create_time >= #{startDate}
        AND create_time < #{endDate}
      GROUP BY DATE(create_time)
â€‹```

### æ–¹å¼äºŒï¼šæ•°æ®åº“é…ç½®

â€‹```sql
-- åˆ›å»º SQL é…ç½®è¡¨
CREATE TABLE sys_sql (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    sql_key VARCHAR(100) NOT NULL UNIQUE,
    sql_content TEXT NOT NULL,
    description VARCHAR(255),
    is_deleted TINYINT DEFAULT 0,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥é¢„è®¾ SQL
INSERT INTO sys_sql (sql_key, sql_content, description) VALUES
('user.findByCondition', 
 'SELECT * FROM user WHERE is_deleted = 0 [AND status = #{status}] [AND name LIKE #{name}]',
 'æ¡ä»¶æŸ¥è¯¢ç”¨æˆ·');
â€‹```

## åŸºç¡€ä½¿ç”¨

â€‹```java
// è·å–é¢„è®¾ SQL
SqlKeyQuery query = DB.sqlSelect("user.findByCondition");

// æ·»åŠ å‚æ•°
query.addPara("status", 1);
query.addPara("name", "å¼ ä¸‰");

// æ‰§è¡ŒæŸ¥è¯¢
List<User> users = query.queryList(User.class);
â€‹```
```

---

## 8.2 åŠ¨æ€æ¡ä»¶

```markdown
# åŠ¨æ€æ¡ä»¶

## æ–¹æ‹¬å·è¯­æ³•

ä½¿ç”¨ `[æ¡ä»¶]` è¯­æ³•ï¼Œå½“å‚æ•°ä¸ºç©ºæ—¶è‡ªåŠ¨å¿½ç•¥è¯¥æ¡ä»¶ï¼š

â€‹```sql
-- é¢„è®¾ SQL
user.search: |
  SELECT * FROM user 
  WHERE is_deleted = 0
  [AND status = #{status}]
  [AND name LIKE CONCAT('%', #{name}, '%')]
  [AND age >= #{minAge}]
  [AND age <= #{maxAge}]
  [AND city = #{city}]
  ORDER BY create_time DESC
â€‹```

â€‹```java
SqlKeyQuery query = DB.sqlSelect("user.search");

// åªä¼ äº† status å’Œ name
query.addPara("status", 1);
query.addPara("name", "å¼ ");
// minAge, maxAge, city æœªä¼ 

List<User> users = query.queryList(User.class);

// ç”Ÿæˆçš„ SQLï¼š
// SELECT * FROM user 
// WHERE is_deleted = 0
// AND status = 1
// AND name LIKE CONCAT('%', 'å¼ ', '%')
// ORDER BY create_time DESC
//
// æ³¨æ„ï¼šminAge, maxAge, city æ¡ä»¶è¢«è‡ªåŠ¨å¿½ç•¥
â€‹```

## å¤æ‚åŠ¨æ€æ¡ä»¶

â€‹```sql
-- æ”¯æŒ OR æ¡ä»¶
user.complexSearch: |
  SELECT * FROM user 
  WHERE is_deleted = 0
  [AND (name = #{name} OR code = #{code})]
  [AND status IN (#{statusList})]
â€‹```

## åŠ¨æ€æ’åº

â€‹```sql
-- ä½¿ç”¨ ${} ç›´æ¥æ›¿æ¢ï¼ˆæ³¨æ„å®‰å…¨æ€§ï¼‰
user.dynamicSort: |
  SELECT * FROM user 
  WHERE is_deleted = 0
  ORDER BY ${sortField} ${sortOrder}
â€‹```

â€‹```java
SqlKeyQuery query = DB.sqlSelect("user.dynamicSort");
query.addPara("sortField", "create_time");  // âš ï¸ éœ€è¦æ ¡éªŒç™½åå•
query.addPara("sortOrder", "DESC");
â€‹```

## å®‰å…¨æç¤º

â€‹```java
// ${} æ˜¯ç›´æ¥æ›¿æ¢ï¼Œå­˜åœ¨ SQL æ³¨å…¥é£é™©
// ä½¿ç”¨å‰å¿…é¡»æ ¡éªŒå‚æ•°å€¼

Set<String> allowedFields = Set.of("id", "name", "create_time");
String sortField = request.getParameter("sort");

if (!allowedFields.contains(sortField)) {
    throw new IllegalArgumentException("éæ³•æ’åºå­—æ®µ");
}

query.addPara("sortField", sortField);
â€‹```
```

---

## 8.3 SQL åµŒå¥—

```markdown
# SQL åµŒå¥—

## åµŒå¥—å¼•ç”¨

é¢„è®¾ SQL å¯ä»¥å¼•ç”¨å…¶ä»–é¢„è®¾ SQLï¼š

â€‹```sql
-- åŸºç¡€æ¡ä»¶
user.baseCondition: |
  is_deleted = 0
  [AND status = #{status}]
  [AND dept_id = #{deptId}]

-- æŸ¥è¯¢ SQLï¼Œå¼•ç”¨åŸºç¡€æ¡ä»¶
user.list: |
  SELECT * FROM user 
  WHERE ${user.baseCondition}
  ORDER BY create_time DESC

-- ç»Ÿè®¡ SQLï¼ŒåŒæ ·å¼•ç”¨åŸºç¡€æ¡ä»¶
user.count: |
  SELECT COUNT(*) FROM user 
  WHERE ${user.baseCondition}
â€‹```

â€‹```java
// å‚æ•°ä¼šä¼ é€’åˆ°åµŒå¥—çš„ SQL ä¸­
SqlKeyQuery query = DB.sqlSelect("user.list");
query.addPara("status", 1);
query.addPara("deptId", 100);

List<User> users = query.queryList(User.class);

// ç”Ÿæˆ SQLï¼š
// SELECT * FROM user 
// WHERE is_deleted = 0 AND status = 1 AND dept_id = 100
// ORDER BY create_time DESC
â€‹```

## ä½¿ç”¨ _sql å‚æ•°

â€‹```java
// é€šè¿‡ _sql å‚æ•°åŠ¨æ€æŒ‡å®šåµŒå¥—çš„ SQL key
SqlKeyQuery query = DB.sqlSelect("common.pagedQuery");
query.addPara("_sql", "user.baseCondition");
â€‹```

## å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæƒé™æ•°æ®è¿‡æ»¤

â€‹```sql
-- æ•°æ®æƒé™æ¡ä»¶ï¼ˆæ ¹æ®å½“å‰ç”¨æˆ·åŠ¨æ€ç”Ÿæˆï¼‰
data.permission: |
  [AND dept_id IN (${userDeptIds})]
  [AND create_by = #{currentUserId}]

-- ä¸šåŠ¡æŸ¥è¯¢å¼•ç”¨æƒé™æ¡ä»¶
order.list: |
  SELECT * FROM orders 
  WHERE is_deleted = 0
  ${data.permission}
  ORDER BY create_time DESC
â€‹```

### åœºæ™¯2ï¼šå¤šç§Ÿæˆ·è¿‡æ»¤

â€‹```sql
-- ç§Ÿæˆ·æ¡ä»¶
tenant.condition: |
  tenant_id = #{tenantId}

-- æ‰€æœ‰ä¸šåŠ¡è¡¨æŸ¥è¯¢éƒ½å¼•ç”¨
user.list: |
  SELECT * FROM user WHERE ${tenant.condition} [AND status = #{status}]
  
order.list: |
  SELECT * FROM orders WHERE ${tenant.condition} [AND status = #{status}]
â€‹```
```

---

# ğŸ“˜ ç¬¬ä¹ç« ï¼šå¤šæ•°æ®æº

## 9.1 é…ç½®

```markdown
# å¤šæ•°æ®æºé…ç½®

## é…ç½®ç¤ºä¾‹

â€‹```yaml
spring:
  datasource:
    # ä¸»åº“
    master:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://master-host:3306/db_master
      username: root
      password: master123
    
    # ä»åº“
    slave:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://slave-host:3306/db_slave
      username: root
      password: slave123
    
    # å…¶ä»–ä¸šåŠ¡åº“
    report:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://report-host:3306/db_report
      username: root
      password: report123

dlz:
  db:
    # é»˜è®¤æ•°æ®æº
    default-datasource: master
â€‹```

## ä»£ç é…ç½®ï¼ˆå¯é€‰ï¼‰

â€‹```java
@Configuration
public class DataSourceConfig {

    @Bean
    @Primary
    public DataSource masterDataSource() {
        // é…ç½®ä¸»åº“
    }
    
    @Bean("slaveDataSource")
    public DataSource slaveDataSource() {
        // é…ç½®ä»åº“
    }
}
â€‹```
```

---

## 9.2 åˆ‡æ¢ä¸äº‹åŠ¡

```markdown
# æ•°æ®æºåˆ‡æ¢ä¸äº‹åŠ¡

## åˆ‡æ¢æ•°æ®æº

â€‹```java
// ä½¿ç”¨é»˜è®¤æ•°æ®æºï¼ˆmasterï¼‰
DB.query(User.class).list();

// åˆ‡æ¢åˆ°ä»åº“æŸ¥è¯¢
DB.use("slave").query(User.class).list();

// åˆ‡æ¢åˆ°æŠ¥è¡¨åº“
List<ResultMap> report = DB.use("report")
    .jdbcSelect("SELECT * FROM daily_report")
    .queryList();
â€‹```

## é“¾å¼åˆ‡æ¢

â€‹```java
// ä»åº“æŸ¥è¯¢
List<User> users = DB.use("slave")
    .query(User.class)
    .eq(User::getStatus, 1)
    .orderByDesc(User::getCreateTime)
    .list();

// ä¸»åº“å†™å…¥
DB.use("master").insert(user).execute();
â€‹```

## äº‹åŠ¡æ§åˆ¶

### å•æ•°æ®æºäº‹åŠ¡

â€‹```java
@Service
public class UserService {

    @Transactional
    public void createUser(User user) {
        // åŒä¸€äº‹åŠ¡å†…çš„æ“ä½œ
        DB.insert(user).execute();
        DB.insert(userLog).execute();
    }
}
â€‹```

### è·¨æ•°æ®æºï¼ˆéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ï¼‰

â€‹```java
@Service
public class OrderService {

    // âš ï¸ è·¨æ•°æ®æºæ“ä½œéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡æ”¯æŒ
    @Transactional
    public void createOrder(Order order) {
        // ä¸»åº“å†™è®¢å•
        DB.use("master").insert(order).execute();
        
        // æŠ¥è¡¨åº“å†™ç»Ÿè®¡ï¼ˆä¸åœ¨åŒä¸€äº‹åŠ¡ï¼ï¼‰
        DB.use("report").insert(stats).execute();
    }
}
â€‹```

## è¯»å†™åˆ†ç¦»å»ºè®®

â€‹```java
@Service
public class UserService {

    // å†™æ“ä½œ â†’ ä¸»åº“
    public void save(User user) {
        DB.use("master").insert(user).execute();
    }
    
    // è¯»æ“ä½œ â†’ ä»åº“
    public User getById(Long id) {
        return DB.use("slave")
            .query(User.class)
            .eq(User::getId, id)
            .one();
    }
    
    // éœ€è¦è¯»å–æœ€æ–°æ•°æ® â†’ ä¸»åº“
    public User getByIdFromMaster(Long id) {
        return DB.use("master")
            .query(User.class)
            .eq(User::getId, id)
            .one();
    }
}
â€‹```
```

---

# ğŸ“˜ ç¬¬åç« ï¼šæ—¥å¿—è°ƒè¯•

## 10.1 SQL æ—¥å¿—

```markdown
# SQL æ—¥å¿—

## å¼€å¯æ—¥å¿—

â€‹```yaml
dlz:
  db:
    # æ˜¯å¦æ‰“å° SQL
    show-sql: true
    # æ˜¯å¦æ ¼å¼åŒ– SQL
    format-sql: true
    # æ…¢ SQL é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
    slow-sql-threshold: 1000
â€‹```

## æ—¥å¿—è¾“å‡ºæ ¼å¼

â€‹```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [SQL]   SELECT * FROM user WHERE id = 1 AND is_deleted = 0         â”‚
â”‚ [å‚æ•°]  id=1                                                         â”‚
â”‚ [è€—æ—¶]  15ms                                                         â”‚
â”‚ [è°ƒç”¨]  c.e.service.UserService.getById(UserService.java:42)        â”‚
â”‚               â””â”€ c.e.controller.UserController.detail(UC.java:28)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â€‹```

## æ…¢ SQL è­¦å‘Š

â€‹```
âš ï¸ [æ…¢SQL] æ‰§è¡Œæ—¶é—´ 2350ms è¶…è¿‡é˜ˆå€¼ 1000ms
[SQL]   SELECT * FROM orders WHERE create_time > '2020-01-01'
[è°ƒç”¨]  c.e.service.OrderService.findAll(OrderService.java:56)
â€‹```

## æ—¥å¿—çº§åˆ«æ§åˆ¶

â€‹```yaml
logging:
  level:
    com.dlz.db: DEBUG    # å¼€å¯è¯¦ç»†æ—¥å¿—
    com.dlz.db.sql: INFO # SQL æ—¥å¿—
â€‹```
```

---

## 10.2 ä»£ç å®šä½

```markdown
# SQL ä»£ç å®šä½ï¼ˆç‹¬å®¶ç‰¹æ€§ï¼‰

## ç—›ç‚¹

â€‹```
ä¼ ç»Ÿå¼€å‘ä¸­çš„é—®é¢˜ï¼š

1. æ§åˆ¶å°çœ‹åˆ°ä¸€æ¡æ…¢ SQL
2. ä¸çŸ¥é“æ˜¯å“ªä¸ª Controller/Service æ‰§è¡Œçš„
3. å…¨å±€æœç´¢ SQL å…³é”®è¯ â†’ æ‰¾åˆ° 10+ ä¸ªåœ°æ–¹
4. ä¸€ä¸ªä¸ªæ’æŸ¥... 
5. æµªè´¹ 30 åˆ†é’Ÿ

DLZ-DBï¼šç›´æ¥å‘Šè¯‰ä½ æ˜¯å“ªè¡Œä»£ç ï¼
â€‹```

## æ•ˆæœå¯¹æ¯”

### ä¼ ç»Ÿ MyBatis æ—¥å¿—
â€‹```
DEBUG - ==>  Preparing: SELECT * FROM user WHERE status = ?
DEBUG - ==> Parameters: 1(Integer)
DEBUG - <==      Total: 50

// ç„¶åå‘¢ï¼Ÿè¿™ SQL æ˜¯ä»å“ªæ¥çš„ï¼ŸğŸ¤·â€â™‚ï¸
â€‹```

### DLZ-DB æ—¥å¿—
â€‹```
[SQL]   SELECT * FROM user WHERE status = 1 AND is_deleted = 0
[è€—æ—¶]  45ms
[è°ƒç”¨]  com.example.service.UserService.findActive(UserService.java:67)
                 â†“
        com.example.controller.UserController.list(UserController.java:34)
        
// ç‚¹å‡» UserService.java:67 ç›´æ¥è·³è½¬åˆ°ä»£ç ä½ç½®ï¼âœ…
â€‹```

## å®ç°åŸç†

â€‹```java
// DLZ-DB å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ï¼‰
public void logSql(String sql, long costMs) {
    // 1. è·å–è°ƒç”¨æ ˆ
    StackTraceElement[] stack = Thread.currentThread().getStackTrace();
    
    // 2. è¿‡æ»¤æ¡†æ¶ä»£ç ï¼Œæ‰¾åˆ°ä¸šåŠ¡ä»£ç 
    String location = findBusinessCode(stack);
    
    // 3. æ ¼å¼åŒ–è¾“å‡º
    log.info("[SQL]   {}", sql);
    log.info("[è€—æ—¶]  {}ms", costMs);
    log.info("[è°ƒç”¨]  {}", location);
}
â€‹```

## è°ƒç”¨é“¾æ·±åº¦

â€‹```yaml
dlz:
  db:
    # æ˜¾ç¤ºè°ƒç”¨é“¾æ·±åº¦ï¼ˆé»˜è®¤ 2ï¼‰
    stack-trace-depth: 3
â€‹```

â€‹```
[è°ƒç”¨]  UserService.findActive(UserService.java:67)
           â””â”€ UserController.list(UserController.java:34)
               â””â”€ DispatcherServlet.doDispatch(DispatcherServlet.java:1067)
â€‹```

## IDE é›†æˆ

ä¸»æµ IDE éƒ½æ”¯æŒç‚¹å‡»è·³è½¬ï¼š
- IntelliJ IDEA âœ…
- Eclipse âœ…
- VS Code âœ…

æ—¥å¿—æ ¼å¼ `ClassName.method(File.java:è¡Œå·)` ç¬¦åˆæ ‡å‡†ï¼Œå¯ç›´æ¥ç‚¹å‡»è·³è½¬ã€‚
```

---

# ğŸ“˜ ç¬¬åä¸€ç« ï¼šé«˜çº§ç‰¹æ€§

## 11.1 é€»è¾‘åˆ é™¤

```markdown
# é€»è¾‘åˆ é™¤

## è‡ªåŠ¨è¯†åˆ«

å½“ Bean ä¸­å­˜åœ¨ä»¥ä¸‹å­—æ®µæ—¶ï¼Œè‡ªåŠ¨å¯ç”¨é€»è¾‘åˆ é™¤ï¼š
- `isDeleted`
- `deleted`
- `is_deleted`ï¼ˆé…ç½®æŒ‡å®šï¼‰

## é…ç½®

â€‹```yaml
dlz:
  db:
    # é€»è¾‘åˆ é™¤å­—æ®µ
    logic-delete-field: is_deleted
    # å·²åˆ é™¤å€¼
    logic-delete-value: 1
    # æœªåˆ é™¤å€¼
    logic-not-delete-value: 0
â€‹```

## è‡ªåŠ¨è¡Œä¸º

### æŸ¥è¯¢è‡ªåŠ¨è¿‡æ»¤

â€‹```java
DB.query(User.class).eq(User::getStatus, 1).list();

// è‡ªåŠ¨æ·»åŠ æ¡ä»¶ï¼š
// SELECT * FROM user WHERE status = 1 AND is_deleted = 0
â€‹```

### åˆ é™¤å˜æ›´æ–°

â€‹```java
DB.delete(User.class).eq(User::getId, 1).execute();

// å®é™…æ‰§è¡Œï¼š
// UPDATE user SET is_deleted = 1 WHERE id = 1 AND is_deleted = 0
â€‹```

### æ›´æ–°è‡ªåŠ¨è¿‡æ»¤

â€‹```java
DB.update(user).eq(User::getId, 1).execute();

// è‡ªåŠ¨æ·»åŠ æ¡ä»¶ï¼š
// UPDATE user SET ... WHERE id = 1 AND is_deleted = 0
â€‹```

## æŸ¥è¯¢å·²åˆ é™¤æ•°æ®

â€‹```java
// ä¸´æ—¶å¿½ç•¥é€»è¾‘åˆ é™¤
DB.query(User.class)
    .ignoreLogicDelete()
    .eq(User::getId, 1)
    .one();

// ç”Ÿæˆ SQLï¼ˆæ—  is_deleted æ¡ä»¶ï¼‰ï¼š
// SELECT * FROM user WHERE id = 1
â€‹```

## ç‰©ç†åˆ é™¤

â€‹```java
// çœŸæ­£åˆ é™¤æ•°æ®
DB.deletePhysical(User.class)
    .eq(User::getId, 1)
    .execute();

// æ‰§è¡Œï¼šDELETE FROM user WHERE id = 1
â€‹```
```

---

## 11.2 æ‰¹é‡æ“ä½œ

```markdown
# æ‰¹é‡æ“ä½œ

## æ‰¹é‡æ’å…¥

â€‹```java
List<User> users = Arrays.asList(
    new User("å¼ ä¸‰", 25),
    new User("æå››", 30),
    new User("ç‹äº”", 28)
);

// æ‰¹é‡æ’å…¥
int count = DB.insertBatch(users).execute();

// æ‰¹é‡æ’å…¥å¹¶è¿”å›ä¸»é”®
List<Long> ids = DB.insertBatch(users).insertWithAutoKeys();
â€‹```

## æ‰¹é‡æ›´æ–°

â€‹```java
// æ–¹å¼1ï¼šå¾ªç¯æ›´æ–°
users.forEach(user -> {
    DB.update(user).eq(User::getId, user.getId()).execute();
});

// æ–¹å¼2ï¼šæ¡ä»¶æ‰¹é‡æ›´æ–°
DB.update(User.class)
    .set(User::getStatus, 0)
    .in(User::getId, Arrays.asList(1, 2, 3, 4, 5))
    .execute();
â€‹```

## æ‰¹é‡åˆ é™¤

â€‹```java
DB.delete(User.class)
    .in(User::getId, Arrays.asList(1, 2, 3, 4, 5))
    .execute();

// æˆ–ä½¿ç”¨å­—ç¬¦ä¸²
DB.delete(User.class)
    .in(User::getId, "1,2,3,4,5")
    .execute();
â€‹```

## æ€§èƒ½å»ºè®®

â€‹```java
// âŒ é¿å…å¾ªç¯å•æ¡æ“ä½œ
for (User user : users) {
    DB.insert(user).execute();  // æ¯æ¬¡éƒ½æ˜¯ç‹¬ç«‹è¿æ¥
}

// âœ… ä½¿ç”¨æ‰¹é‡æ“ä½œ
DB.insertBatch(users).execute();  // ä¸€æ¬¡è¿æ¥ï¼Œæ‰¹é‡æ‰§è¡Œ
â€‹```
```

---

## 11.3 äº‹åŠ¡ç®¡ç†

```markdown
# äº‹åŠ¡ç®¡ç†

## å£°æ˜å¼äº‹åŠ¡ï¼ˆæ¨èï¼‰

â€‹```java
@Service
public class OrderService {

    @Transactional
    public void createOrder(Order order, List<OrderItem> items) {
        // æ’å…¥è®¢å•
        Long orderId = DB.insert(order).insertWithAutoKey();
        
        // æ’å…¥è®¢å•é¡¹
        items.forEach(item -> {
            item.setOrderId(orderId);
            DB.insert(item).execute();
        });
        
        // æ‰£å‡åº“å­˜
        items.forEach(item -> {
            DB.update("product")
                .setSql("stock = stock - " + item.getQuantity())
                .eq("id", item.getProductId())
                .execute();
        });
        
        // ä»»ä½•å¼‚å¸¸éƒ½ä¼šå›æ»š
    }
}
â€‹```

## äº‹åŠ¡ä¼ æ’­

â€‹```java
@Transactional(propagation = Propagation.REQUIRED)
public void methodA() {
    // é»˜è®¤ä¼ æ’­è¡Œä¸ºï¼šå­˜åœ¨äº‹åŠ¡åˆ™åŠ å…¥ï¼Œå¦åˆ™åˆ›å»ºæ–°äº‹åŠ¡
}

@Transactional(propagation = Propagation.REQUIRES_NEW)
public void methodB() {
    // æ€»æ˜¯åˆ›å»ºæ–°äº‹åŠ¡
}

@Transactional(propagation = Propagation.NESTED)
public void methodC() {
    // åµŒå¥—äº‹åŠ¡ï¼ˆæ”¯æŒä¿å­˜ç‚¹ï¼‰
}
â€‹```

## åªè¯»äº‹åŠ¡

â€‹```java
@Transactional(readOnly = true)
public List<User> findAll() {
    return DB.query(User.class).list();
}
â€‹```

## å¼‚å¸¸å›æ»š

â€‹```java
// é»˜è®¤åªå›æ»š RuntimeException
@Transactional

// å›æ»šæ‰€æœ‰å¼‚å¸¸
@Transactional(rollbackFor = Exception.class)

// ä¸å›æ»šç‰¹å®šå¼‚å¸¸
@Transactional(noRollbackFor = BusinessException.class)
â€‹```
```

---

# ğŸ“˜ ç¬¬åäºŒç« ï¼šæœ€ä½³å®è·µ

## 12.1 ä½¿ç”¨å»ºè®®

```markdown
# ä½¿ç”¨å»ºè®®

## åœºæ™¯é€‰æ‹©

| åœºæ™¯ | æ¨èæ–¹å¼ | è¯´æ˜ |
|------|---------|------|
| ç®€å• CRUD | Wrapper | ç±»å‹å®‰å…¨ï¼Œæ¨è |
| åŠ¨æ€è¡¨å | Maker | çµæ´» |
| å¤æ‚æŸ¥è¯¢ | åŸç”Ÿ SQL / é¢„è®¾ SQL | å¯è¯»æ€§å¥½ |
| æŠ¥è¡¨ç»Ÿè®¡ | é¢„è®¾ SQL | ä¾¿äºç»´æŠ¤ |
| æ‰¹é‡æ“ä½œ | æ‰¹é‡ API | æ€§èƒ½å¥½ |

## ä»£ç ç»„ç»‡

### ç®€å•ä¸šåŠ¡ï¼šController ç›´æ¥è°ƒç”¨

â€‹```java
@RestController
public class UserController {

    @GetMapping("/users")
    public List<User> list(@RequestParam(required = false) Integer status) {
        return DB.query(User.class)
            .eq(status != null, User::getStatus, status)
            .list();
    }
}
â€‹```

### å¤æ‚ä¸šåŠ¡ï¼šå°è£… Query ç±»

â€‹```java
// æŸ¥è¯¢ç±»å°è£…
public class UserQuery {
    
    public static List<User> findByCondition(UserSearchDTO dto) {
        return DB.query(User.class)
            .eq(dto.getStatus() != null, User::getStatus, dto.getStatus())
            .like(StringUtil.isNotBlank(dto.getName()), User::getName, dto.getName())
            .between(dto.getStartDate() != null, User::getCreateTime, dto.getStartDate(), dto.getEndDate())
            .orderByDesc(User::getCreateTime)
            .list();
    }
}

// Controller è°ƒç”¨
@GetMapping("/users")
public List<User> list(UserSearchDTO dto) {
    return UserQuery.findByCondition(dto);
}
â€‹```

### éœ€è¦äº‹åŠ¡ï¼šService å±‚

â€‹```java
@Service
public class OrderService {

    @Transactional
    public Long createOrder(OrderDTO dto) {
        // å¤æ‚ä¸šåŠ¡é€»è¾‘
        // ...
    }
}
â€‹```

## æ¡ä»¶æ„å»º

â€‹```java
// âœ… æ¨èï¼šæ¡ä»¶åˆ¤æ–­å‰ç½®
DB.query(User.class)
    .eq(status != null, User::getStatus, status)
    .like(StringUtil.isNotBlank(name), User::getName, name)
    .list();

// âŒ ä¸æ¨èï¼šå¤§é‡ if-else
WrapperQuery<User> query = DB.query(User.class);
if (status != null) {
    query.eq(User::getStatus, status);
}
if (StringUtil.isNotBlank(name)) {
    query.like(User::getName, name);
}
// ...å¤ªå¤š if-else
â€‹```
```

---

## 12.2 æ€§èƒ½ä¼˜åŒ–

```markdown
# æ€§èƒ½ä¼˜åŒ–

## æŸ¥è¯¢ä¼˜åŒ–

### åªæŸ¥éœ€è¦çš„å­—æ®µ

â€‹```java
// âŒ æŸ¥è¯¢å…¨éƒ¨å­—æ®µ
DB.query(User.class).list();

// âœ… åªæŸ¥éœ€è¦çš„å­—æ®µ
DB.query(User.class)
    .select(User::getId, User::getName)
    .list();
â€‹```

### åˆ†é¡µæŸ¥è¯¢

â€‹```java
// âŒ æŸ¥è¯¢å…¨éƒ¨å†æˆªå–
List<User> all = DB.query(User.class).list();
List<User> page = all.subList(0, 10);

// âœ… æ•°æ®åº“åˆ†é¡µ
Page<User> page = DB.query(User.class)
    .page(Page.build(1, 10))
    .page();
â€‹```

### é¿å… N+1 é—®é¢˜

â€‹```java
// âŒ N+1 é—®é¢˜
List<Order> orders = DB.query(Order.class).list();
for (Order order : orders) {
    User user = DB.query(User.class)
        .eq(User::getId, order.getUserId())
        .one();  // æ¯æ¬¡å¾ªç¯éƒ½æŸ¥è¯¢
}

// âœ… æ‰¹é‡æŸ¥è¯¢
List<Order> orders = DB.query(Order.class).list();
List<Long> userIds = orders.stream()
    .map(Order::getUserId)
    .distinct()
    .collect(Collectors.toList());
    
Map<Long, User> userMap = DB.query(User.class)
    .in(User::getId, userIds)
    .list()
    .stream()
    .collect(Collectors.toMap(User::getId, u -> u));
â€‹```

## å†™å…¥ä¼˜åŒ–

### æ‰¹é‡æ’å…¥

â€‹```java
// âŒ å¾ªç¯å•æ¡æ’å…¥
for (User user : users) {
    DB.insert(user).execute();
}

// âœ… æ‰¹é‡æ’å…¥
DB.insertBatch(users).execute();
â€‹```

## ç´¢å¼•ä¼˜åŒ–

â€‹```java
// âœ… ä½¿ç”¨ç´¢å¼•å­—æ®µä½œä¸ºæŸ¥è¯¢æ¡ä»¶
DB.query(User.class)
    .eq(User::getId, id)        // ä¸»é”®ç´¢å¼•
    .eq(User::getPhone, phone)  // å”¯ä¸€ç´¢å¼•
    .list();

// âš ï¸ é¿å…ç´¢å¼•å¤±æ•ˆ
DB.query(User.class)
    .apply("YEAR(create_time) = {0}", 2024)  // å‡½æ•°å¯¼è‡´ç´¢å¼•å¤±æ•ˆ
    .list();

// âœ… æ”¹ä¸ºèŒƒå›´æŸ¥è¯¢
DB.query(User.class)
    .between(User::getCreateTime, startOfYear, endOfYear)
    .list();
â€‹```
```

---

## 12.3 å®‰å…¨è§„èŒƒ

```markdown
# å®‰å…¨è§„èŒƒ

## SQL æ³¨å…¥é˜²æŠ¤

### ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢

â€‹```java
// âœ… å®‰å…¨ï¼šå‚æ•°åŒ–æŸ¥è¯¢
DB.query(User.class)
    .eq(User::getName, userInput)
    .list();

// âœ… å®‰å…¨ï¼šä½¿ç”¨ #{} å ä½ç¬¦
DB.sqlSelect("user.find")
    .addPara("name", userInput)
    .queryList();

// âœ… å®‰å…¨ï¼šä½¿ç”¨ ? å ä½ç¬¦
DB.jdbcSelect("SELECT * FROM user WHERE name = ?", userInput)
    .queryList();

// âŒ å±é™©ï¼šå­—ç¬¦ä¸²æ‹¼æ¥
String sql = "SELECT * FROM user WHERE name = '" + userInput + "'";
â€‹```

### åŠ¨æ€æ’åºå®‰å…¨

â€‹```java
// âŒ å±é™©ï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥
String sort = request.getParameter("sort");
query.addPara("sortField", sort);

// âœ… å®‰å…¨ï¼šç™½åå•æ ¡éªŒ
Set<String> ALLOWED_SORTS = Set.of("id", "name", "create_time");
String sort = request.getParameter("sort");
if (!ALLOWED_SORTS.contains(sort)) {
    sort = "create_time";  // é»˜è®¤å€¼
}
query.addPara("sortField", sort);
â€‹```

## æ•æ„Ÿæ•°æ®å¤„ç†

â€‹```java
// æ—¥å¿—è„±æ•ï¼ˆé…ç½®ï¼‰
dlz:
  db:
    # éœ€è¦è„±æ•çš„å­—æ®µ
    sensitive-fields:
      - password
      - phone
      - id_card
â€‹```

## æƒé™æ§åˆ¶

â€‹```java
// æ•°æ®æƒé™è¿‡æ»¤
public List<Order> findMyOrders() {
    Long currentUserId = SecurityContext.getCurrentUserId();
    
    return DB.query(Order.class)
        .eq(Order::getUserId, currentUserId)  // åªèƒ½çœ‹è‡ªå·±çš„
        .list();
}
â€‹```
```

---

# ğŸ“˜ ç¬¬åä¸‰ç« ï¼šAPI å‚è€ƒ

## 13.1 DB ç±»

```markdown
# DB ç±» API

> æ‰€æœ‰æ•°æ®åº“æ“ä½œçš„ç»Ÿä¸€å…¥å£

## æŸ¥è¯¢æ–¹æ³•

| æ–¹æ³• | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `query(Class<T>)` | `WrapperQuery<T>` | Bean æŸ¥è¯¢ |
| `query(String tableName)` | `MakerSelect` | è¡¨åæŸ¥è¯¢ |
| `jdbcSelect(String sql, Object... args)` | `JdbcQuery` | åŸç”Ÿ SQL æŸ¥è¯¢ |
| `sqlSelect(String key)` | `SqlKeyQuery` | é¢„è®¾ SQL æŸ¥è¯¢ |

## æ’å…¥æ–¹æ³•

| æ–¹æ³• | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `insert(T bean)` | `WrapperInsert<T>` | Bean æ’å…¥ |
| `insert(String tableName)` | `MakerInsert` | è¡¨åæ’å…¥ |
| `insertBatch(List<T>)` | `BatchInsert<T>` | æ‰¹é‡æ’å…¥ |

## æ›´æ–°æ–¹æ³•

| æ–¹æ³• | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `update(T bean)` | `WrapperUpdate<T>` | Bean æ›´æ–° |
| `update(String tableName)` | `MakerUpdate` | è¡¨åæ›´æ–° |

## åˆ é™¤æ–¹æ³•

| æ–¹æ³• | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `delete(Class<T>)` | `WrapperDelete<T>` | Bean åˆ é™¤ |
| `delete(String tableName)` | `MakerDelete` | è¡¨ååˆ é™¤ |

## å…¶ä»–æ–¹æ³•

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `use(String datasource)` | åˆ‡æ¢æ•°æ®æº |
```

---

## 13.2 Wrapper ç±»

```markdown
# Wrapper ç±» API

## WrapperQuery<T> æŸ¥è¯¢æ–¹æ³•

### æ¡ä»¶æ–¹æ³•

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `eq(å­—æ®µ, å€¼)` | ç­‰äº |
| `ne(å­—æ®µ, å€¼)` | ä¸ç­‰äº |
| `gt(å­—æ®µ, å€¼)` | å¤§äº |
| `ge(å­—æ®µ, å€¼)` | å¤§äºç­‰äº |
| `lt(å­—æ®µ, å€¼)` | å°äº |
| `le(å­—æ®µ, å€¼)` | å°äºç­‰äº |
| `like(å­—æ®µ, å€¼)` | LIKE %å€¼% |
| `likeLeft(å­—æ®µ, å€¼)` | LIKE %å€¼ |
| `likeRight(å­—æ®µ, å€¼)` | LIKE å€¼% |
| `in(å­—æ®µ, å€¼)` | IN |
| `notIn(å­—æ®µ, å€¼)` | NOT IN |
| `between(å­—æ®µ, å€¼1, å€¼2)` | BETWEEN |
| `isNull(å­—æ®µ)` | IS NULL |
| `isNotNull(å­—æ®µ)` | IS NOT NULL |
| `or(Consumer)` | OR æ¡ä»¶ |
| `and(Consumer)` | AND æ¡ä»¶ |
| `apply(sql, args)` | è‡ªå®šä¹‰ SQL |
| `sql(sql, params)` | è‡ªå®šä¹‰ SQL |

### ç»“æœæ–¹æ³•

| æ–¹æ³• | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `one()` | `T` | å•æ¡ Bean |
| `oneMap()` | `ResultMap` | å•æ¡ Map |
| `list()` | `List<T>` | åˆ—è¡¨ |
| `listMap()` | `List<ResultMap>` | Map åˆ—è¡¨ |
| `count()` | `long` | æ•°é‡ |
| `page()` | `Page<T>` | åˆ†é¡µç»“æœ |

### å…¶ä»–æ–¹æ³•

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `select(å­—æ®µ...)` | æŒ‡å®šæŸ¥è¯¢å­—æ®µ |
| `orderByAsc(å­—æ®µ)` | å‡åºæ’åº |
| `orderByDesc(å­—æ®µ)` | é™åºæ’åº |
| `page(Page)` | è®¾ç½®åˆ†é¡µ |
```

---

## 13.3 Condition ç±»

```markdown
# Condition ç±» API

> ç‹¬ç«‹çš„æ¡ä»¶æ„é€ å™¨ï¼Œå¯å¤ç”¨

## åˆ›å»º

â€‹```java
Condition condition = Condition.where();
â€‹```

## æ–¹æ³•

ä¸ Wrapper ç›¸åŒï¼Œæ”¯æŒæ‰€æœ‰æ¡ä»¶æ–¹æ³•ï¼š
- `eq`, `ne`, `gt`, `ge`, `lt`, `le`
- `like`, `likeLeft`, `likeRight`
- `in`, `notIn`, `between`
- `isNull`, `isNotNull`
- `or`, `and`
- `apply`, `sql`

## ä½¿ç”¨

â€‹```java
Condition condition = Condition.where()
    .eq("status", 1)
    .gt("age", 18);

// åº”ç”¨åˆ°æŸ¥è¯¢
DB.query("user").where(condition).list();

// åº”ç”¨åˆ°æ›´æ–°
DB.update("user").set("flag", 1).where(condition).execute();

// åº”ç”¨åˆ°åˆ é™¤
DB.delete("user").where(condition).execute();
â€‹```
```

---

## 13.4 Page ç±»

```markdown
# Page ç±» API

## åˆ›å»ºåˆ†é¡µå‚æ•°

â€‹```java
// åŸºç¡€åˆ†é¡µ
Page.build(é¡µç , æ¯é¡µæ¡æ•°)

// å¸¦æ’åº
Page.build(é¡µç , æ¯é¡µæ¡æ•°, Order...)

// ä»…æ’åº
Page.build(Order...)
â€‹```

## Order æ’åº

â€‹```java
Order.asc("å­—æ®µ")      // å‡åº
Order.desc("å­—æ®µ")     // é™åº
Order.ascs("å­—æ®µ"...)  // å¤šå­—æ®µå‡åº
Order.descs("å­—æ®µ"...) // å¤šå­—æ®µé™åº
â€‹```

## åˆ†é¡µç»“æœ

| æ–¹æ³• | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `getRecords()` | `List<T>` | å½“å‰é¡µæ•°æ® |
| `getTotal()` | `long` | æ€»æ¡æ•° |
| `getPages()` | `int` | æ€»é¡µæ•° |
| `getCurrent()` | `int` | å½“å‰é¡µç  |
| `getSize()` | `int` | æ¯é¡µæ¡æ•° |
| `hasNext()` | `boolean` | æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ |
| `hasPrevious()` | `boolean` | æ˜¯å¦æœ‰ä¸Šä¸€é¡µ |
```

---

# ğŸ“˜ ç¬¬åå››ç« ï¼šé™„å½•

## 14.1 FAQ

```markdown
# å¸¸è§é—®é¢˜

## Q: å¦‚ä½•å¤„ç†å¤æ‚çš„ JOIN æŸ¥è¯¢ï¼Ÿ

ä½¿ç”¨åŸç”Ÿ SQL æˆ–é¢„è®¾ SQLï¼š

â€‹```java
String sql = """
    SELECT u.*, d.name as dept_name
    FROM user u
    LEFT JOIN department d ON u.dept_id = d.id
    WHERE u.status = ?
    """;
    
List<ResultMap> list = DB.jdbcSelect(sql, 1).queryList();
â€‹```

## Q: å¦‚ä½•å®ç°ä¹è§‚é”ï¼Ÿ

â€‹```java
// æ›´æ–°æ—¶å¸¦ä¸Šç‰ˆæœ¬å·
int updated = DB.update(User.class)
    .set(User::getName, newName)
    .set(User::getVersion, user.getVersion() + 1)
    .eq(User::getId, user.getId())
    .eq(User::getVersion, user.getVersion())  // ç‰ˆæœ¬å·æ¡ä»¶
    .execute();

if (updated == 0) {
    throw new OptimisticLockException("æ•°æ®å·²è¢«ä¿®æ”¹");
}
â€‹```

## Q: å¦‚ä½•è°ƒè¯• SQLï¼Ÿ

DLZ-DB æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
1. å®Œæ•´å¯æ‰§è¡Œçš„ SQLï¼ˆå‚æ•°å·²å¡«å……ï¼‰
2. æ‰§è¡Œè€—æ—¶
3. è°ƒç”¨ä»£ç ä½ç½®

ç›´æ¥å¤åˆ¶ SQL åˆ°æ•°æ®åº“å·¥å…·æ‰§è¡Œå³å¯è°ƒè¯•ã€‚

## Q: æ€§èƒ½å’Œ MyBatis æ¯”æ€ä¹ˆæ ·ï¼Ÿ

DLZ-DB åº•å±‚åŸºäº JDBCï¼Œæ—  XML è§£æå¼€é”€ï¼Œç†è®ºä¸Šæ›´å¿«ã€‚
å®é™…ä½¿ç”¨ä¸­ï¼ŒSQL æ‰§è¡Œæ—¶é—´æ˜¯ä¸»è¦ç“¶é¢ˆï¼Œæ¡†æ¶å¼€é”€å¯å¿½ç•¥ã€‚
```

---

## 14.2 æ›´æ–°æ—¥å¿—

```markdown
# æ›´æ–°æ—¥å¿—

## v1.2.0 (2024-xx-xx)

### æ–°å¢
- æ”¯æŒ PostgreSQL æ–¹è¨€
- æ–°å¢ `insertOrUpdate` æ–¹æ³•
- ResultMap æ”¯æŒè´Ÿæ•°ç´¢å¼•

### ä¼˜åŒ–
- SQL æ—¥å¿—æ ¼å¼ä¼˜åŒ–
- æ‰¹é‡æ’å…¥æ€§èƒ½æå‡ 50%

### ä¿®å¤
- ä¿®å¤å¤šæ•°æ®æºäº‹åŠ¡é—®é¢˜
- ä¿®å¤ LIKE ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰

---

## v1.1.0 (2024-xx-xx)

### æ–°å¢
- æ”¯æŒé¢„è®¾ SQL åµŒå¥—
- æ–°å¢æ…¢ SQL ç›‘æ§
- æ”¯æŒ Oracle åˆ†é¡µ

### ä¼˜åŒ–
- Lambda è§£ææ€§èƒ½ä¼˜åŒ–

---

## v1.0.0 (2024-xx-xx)

- ğŸ‰ é¦–ä¸ªæ­£å¼ç‰ˆæœ¬å‘å¸ƒ
```

---

## æ–‡æ¡£æ€»ç»“

```
å®Œæ•´æ–‡æ¡£ç»“æ„ï¼š
â”œâ”€â”€ ç¬¬1ç« ï¼šå¿«é€Ÿå¼€å§‹ï¼ˆ3èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬2ç« ï¼šæ ¸å¿ƒæ¦‚å¿µï¼ˆ3èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬3ç« ï¼šåŸºç¡€æ“ä½œï¼ˆ4èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬4ç« ï¼šæ¡ä»¶æ„é€ å™¨ï¼ˆ5èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬5ç« ï¼šåˆ†é¡µæ’åºï¼ˆ2èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬6ç« ï¼šç»“æœæ˜ å°„ï¼ˆ3èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬7ç« ï¼šLambdaè¡¨è¾¾å¼ï¼ˆ1èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬8ç« ï¼šé¢„è®¾SQLï¼ˆ3èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬9ç« ï¼šå¤šæ•°æ®æºï¼ˆ2èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬10ç« ï¼šæ—¥å¿—è°ƒè¯•ï¼ˆ2èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬11ç« ï¼šé«˜çº§ç‰¹æ€§ï¼ˆ3èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬12ç« ï¼šæœ€ä½³å®è·µï¼ˆ3èŠ‚ï¼‰
â”œâ”€â”€ ç¬¬13ç« ï¼šAPIå‚è€ƒï¼ˆ4èŠ‚ï¼‰
â””â”€â”€ ç¬¬14ç« ï¼šé™„å½•ï¼ˆ2èŠ‚ï¼‰

å…±è®¡ï¼š14ç« ï¼Œ40èŠ‚
```

éœ€è¦æˆ‘ç»§ç»­å®Œå–„å“ªä¸ªç« èŠ‚çš„å†…å®¹å—ï¼ŸğŸš€